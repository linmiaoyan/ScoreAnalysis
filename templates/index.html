<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成绩分析系统</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #1a73e8;
            color: white;
            font-weight: bold;
        }
        .btn-primary {
            background-color: #1a73e8;
            border-color: #1a73e8;
        }
        .score-line-input {
            margin: 5px;
        }
        .chart-container {
            height: 400px;
            margin: 20px 0;
        }
        .stat-card {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            margin: 10px 0;
        }
        .stat-card h3 {
            margin: 0;
            font-size: 2rem;
        }
        .stat-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        .alert {
            margin-top: 10px;
        }
        .list-group-item {
            margin-bottom: 5px;
        }
        #scoreLinesList {
            max-height: 300px;
            overflow-y: auto;
        }
        .collapse {
            transition: all 0.3s ease;
        }
        .card-header {
            user-select: none;
        }
        .btn-sm {
            font-size: 0.875rem;
        }
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }
        .nav-tabs .nav-link {
            color: #495057;
            border: 1px solid transparent;
            border-top-left-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
        }
        .nav-tabs .nav-link:hover {
            border-color: #e9ecef #e9ecef #dee2e6;
            isolation: isolate;
        }
        .nav-tabs .nav-link.active {
            color: #495057;
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
        }
        .tab-content {
            padding: 20px 0;
        }
        #subjectTabContent {
            min-height: 300px;
        }
        .nav-tabs .nav-link {
            cursor: pointer;
            transition: all 0.3s;
        }
        .nav-tabs .nav-link:not(.active):hover {
            background-color: #f8f9fa;
        }
        .subject-btn {
            margin: 5px;
            min-width: 80px;
        }
        .subject-btn.active {
            background-color: #1a73e8;
            border-color: #1a73e8;
            color: white;
        }
        .btn-group.flex-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        /* 结果区域：醒目区块标题，便于识别当前所在区域 */
        .result-section-card {
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .result-section-header {
            padding: 14px 20px;
            font-size: 1.15rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            border-left: 4px solid transparent;
        }
        .result-section-header-league { background: linear-gradient(135deg, #0dcaf0 0%, #0aa2c0 100%); color: #fff; border-left-color: #087990; }
        .result-section-header-primary { background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%); color: #fff; border-left-color: #0d47a1; }
        .result-section-header-success { background: linear-gradient(135deg, #198754 0%, #146c43 100%); color: #fff; border-left-color: #0f5132; }
        .result-section-header-info { background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%); color: #fff; border-left-color: #084298; }
        .result-section-header-warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #1a1a1a; border-left-color: #b38600; }
        .result-section-header-secondary { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: #fff; border-left-color: #343a40; }
        .result-section-header-danger { background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%); color: #fff; border-left-color: #842029; }
        #resultsArea .card:first-of-type { margin-top: 0; }
        .snapshot-view #uploadSection { display: none !important; }
    </style>
</head>
<body class="{% if snapshot_mode %}snapshot-view{% endif %}">
    {% if snapshot_mode and snapshot is defined and snapshot %}
    <script>window.__SNAPSHOT__ = {{ snapshot | tojson }};</script>
    {% endif %}
    <div class="container">
        {% if snapshot_mode %}
        <div class="alert alert-info mb-3">
            <span>成绩分析结果快照 · 仅供查看</span>
        </div>
        {% endif %}
        <div id="uploadSection">
        <h1 class="mb-4">成绩分析系统</h1>
        
        <!-- 文件上传区域（仅联盟全体数据） -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">1. 上传数据文件</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" onsubmit="return false;">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="league_file" class="form-label">【联盟全体数据】文件</label>
                            <input type="file" class="form-control" id="league_file" name="league_file" accept=".xlsx,.xls">
                            <small class="form-text text-muted">请上传包含联盟全体成绩的Excel文件（需含“分数”工作表）</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">学校名称/别名（用于筛选，可填多个，任一匹配即视为我校）</label>
                            <div id="schoolNamesList" class="mb-2">
                                <div class="input-group input-group-sm mb-2 school-name-row">
                                    <input type="text" class="form-control school-name-input" placeholder="如：温州科技高级中学" value="温州科技高级中学">
                                    <button type="button" class="btn btn-outline-secondary btn-remove-school" title="删除该行" aria-label="删除">×</button>
                                </div>
                                <div class="input-group input-group-sm mb-2 school-name-row">
                                    <input type="text" class="form-control school-name-input" placeholder="如：温州科技（别名）" value="温州科技">
                                    <button type="button" class="btn btn-outline-secondary btn-remove-school" title="删除该行" aria-label="删除">×</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="addSchoolNameBtn">+ 添加一行</button>
                            <small class="form-text text-muted d-block mt-1">与Excel中“学校”列完全一致即可，可填全称、简称等</small>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary mt-3" id="uploadBtn">上传文件</button>
                </form>
                <div id="uploadStatus" class="mt-3"></div>
            </div>
        </div>
        
        <!-- 分数线设置区域 -->
        <div class="card" id="scoreLineCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">2. 设置分数线</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">总分分数线</label>
                    <div id="scoreLinesList" class="mb-3"></div>
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label">一段线（总分）</label>
                            <input type="number" class="form-control" id="yiduanLine" placeholder="输入一段线分数" step="0.5" oninput="updateScoreLinesDisplay()">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">特控线（总分）</label>
                            <input type="number" class="form-control" id="tekongLine" placeholder="输入特控线分数" step="0.5" oninput="updateScoreLinesDisplay()">
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">各学科分数线（可选）</label>
                    <div id="subjectLinesConfig" class="mb-3"></div>
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title mb-3">设置学科分数线</h6>
                            <div class="mb-3">
                                <label class="form-label">分数线类型</label>
                                <div class="btn-group w-100" role="group" id="lineTypeToggle">
                                    <input type="radio" class="btn-check" name="lineTypeToggle" id="toggleTekong" value="特控线" checked>
                                    <label class="btn btn-outline-danger" for="toggleTekong">特控线</label>
                                    
                                    <input type="radio" class="btn-check" name="lineTypeToggle" id="toggleYiduan" value="一段线">
                                    <label class="btn btn-outline-success" for="toggleYiduan">一段线</label>
                                </div>
                            </div>
                            <div id="subjectLinesInputs">
                                <!-- 学科分数线输入框将动态生成 -->
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-sm btn-secondary" id="clearSubjectLinesBtn">清空所有</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="btn btn-primary" id="analyzeBtn">开始分析</button>
                <button type="button" class="btn btn-success ms-2" id="exportBtn" style="display: none;">导出Excel</button>
                <button type="button" class="btn btn-info ms-2" id="snapshotBtn" style="display: none;">快照</button>
            </div>
        </div>
        </div>
        <!-- /uploadSection -->
        
        <!-- 分析结果区域（由 displayNewResults 动态填充：班级考核、班级各科情况、学科分数线、总分分析等） -->
        <div id="resultsArea" style="display: none;"></div>
    </div>
    
    <!-- 班级详细成绩模态框 -->
    <div class="modal fade" id="classDetailModal" tabindex="-1" aria-labelledby="classDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="classDetailModalLabel">班级详细成绩</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="classDetailContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <script>
        // 等待DOM加载完成
        document.addEventListener('DOMContentLoaded', function() {
        // 确保Bootstrap和ECharts已加载
        if (typeof bootstrap === 'undefined') {
            console.error('Bootstrap未加载');
        }
        if (typeof echarts === 'undefined') {
            console.error('ECharts未加载');
        }
            
        let uploadedFiles = {};
        let subjectLines = {}; // 存储学科分数线 {lineName: {subject: score}}
        let availableSubjects = []; // 可用的学科列表（从文件读取）
        let presetSubjects = ['语文', '数学', '英语', '日语', '物理', '化学', '生物', '政治', '历史', '地理', '技术']; // 与后端 SUBJECT_COLUMNS 一致
        const SUBJECT_ORDER = ['语文', '数学', '英语', '日语', '物理', '化学', '生物', '政治', '历史', '地理', '技术'];
        function sortSubjects(keys) {
            return [...keys].sort((a, b) => {
                const ia = SUBJECT_ORDER.indexOf(a);
                const ib = SUBJECT_ORDER.indexOf(b);
                if (ia !== -1 && ib !== -1) return ia - ib;
                if (ia !== -1) return -1;
                if (ib !== -1) return 1;
                return String(a).localeCompare(b);
            });
        }
        let analysisResults = {}; // 存储分析结果，用于导出
        
        // 学校名称/别名：收集所有非空输入
        function getSchoolNames() {
            const inputs = document.querySelectorAll('.school-name-input');
            const names = [];
            inputs.forEach(input => {
                const v = (input.value || '').trim();
                if (v) names.push(v);
            });
            return names;
        }
        
        // 添加一行学校名称
        document.getElementById('addSchoolNameBtn').addEventListener('click', function() {
            const list = document.getElementById('schoolNamesList');
            const row = document.createElement('div');
            row.className = 'input-group input-group-sm mb-2 school-name-row';
            row.innerHTML = '<input type="text" class="form-control school-name-input" placeholder="学校名称或别名">' +
                '<button type="button" class="btn btn-outline-secondary btn-remove-school" title="删除该行" aria-label="删除">×</button>';
            list.appendChild(row);
        });
        document.getElementById('schoolNamesList').addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-remove-school')) {
                const rows = document.querySelectorAll('.school-name-row');
                if (rows.length > 1) e.target.closest('.school-name-row').remove();
            }
        });
            
            // 初始化检查
            console.log('页面初始化完成');
            const uploadForm = document.getElementById('uploadForm');
            const scoreLineCard = document.getElementById('scoreLineCard');
            console.log('上传表单元素:', uploadForm);
            console.log('分数线设置区域元素:', scoreLineCard);
            
            if (!uploadForm) {
                console.error('错误：找不到上传表单元素 (id=uploadForm)');
            }
            if (!scoreLineCard) {
                console.error('错误：找不到分数线设置区域元素 (id=scoreLineCard)');
            }
        
        // 更新分数线显示（暴露到全局作用域）
        function updateScoreLinesDisplay() {
            const listDiv = document.getElementById('scoreLinesList');
            const yiduanLine = document.getElementById('yiduanLine').value;
            const tekongLine = document.getElementById('tekongLine').value;
            
            let html = '<div class="list-group">';
            if (yiduanLine) {
                html += `
                    <div class="list-group-item">
                        <strong>一段线</strong>: <span class="text-primary">${yiduanLine}分</span>
                    </div>
                `;
            }
            if (tekongLine) {
                html += `
                    <div class="list-group-item">
                        <strong>特控线</strong>: <span class="text-primary">${tekongLine}分</span>
                    </div>
                `;
            }
            if (!yiduanLine && !tekongLine) {
                html += '<p class="text-muted">请设置一段线和特控线</p>';
            }
            html += '</div>';
            listDiv.innerHTML = html;
        }
        
        // 将updateScoreLinesDisplay暴露到全局作用域
        window.updateScoreLinesDisplay = updateScoreLinesDisplay;
        
        // 生成学科分数线输入框
        function generateSubjectLinesInputs() {
            const container = document.getElementById('subjectLinesInputs');
            // 合并预设学科和从文件读取的学科，去重，按语数英物化生政史地顺序
            let allSubjects = [...new Set([...presetSubjects, ...availableSubjects])];
            // 过滤掉自动生成的"Unnamed:"列
            allSubjects = allSubjects.filter(name => name && !name.startsWith('Unnamed:'));
            allSubjects = sortSubjects(allSubjects);
            
            let html = '<div class="row g-2">';
            allSubjects.forEach(subject => {
                const isFromFile = availableSubjects.includes(subject);
                html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text" style="min-width: 80px;">${subject}${isFromFile ? '<small class="text-muted ms-1">(文件)</small>' : ''}</span>
                            <input type="number" 
                                   class="form-control subject-line-input" 
                                   data-subject="${subject}"
                                   placeholder="分数线" 
                                   step="0.5"
                                   value="${subjectLines['特控线']?.[subject] || subjectLines['一段线']?.[subject] || ''}">
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
            
            // 为所有输入框添加事件监听
            container.querySelectorAll('.subject-line-input').forEach(input => {
                input.addEventListener('input', function() {
                    const subject = this.getAttribute('data-subject');
                    const score = parseFloat(this.value);
                    const lineType = document.querySelector('input[name="lineTypeToggle"]:checked').value;
                    
                    if (!isNaN(score) && score > 0) {
                        if (!subjectLines[lineType]) {
                            subjectLines[lineType] = {};
                        }
                        subjectLines[lineType][subject] = score;
                    } else {
                        // 如果输入为空或无效，清除该学科的分数线
                        if (subjectLines[lineType] && subjectLines[lineType][subject]) {
                            delete subjectLines[lineType][subject];
                        }
                    }
                    updateSubjectLinesDisplay();
                });
            });
        }
        
        // 分数线类型切换时，更新输入框的值
        document.querySelectorAll('input[name="lineTypeToggle"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const lineType = this.value;
                document.querySelectorAll('.subject-line-input').forEach(input => {
                    const subject = input.getAttribute('data-subject');
                    input.value = subjectLines[lineType]?.[subject] || '';
                });
            });
        });
        
        // 清空所有学科分数线
        document.getElementById('clearSubjectLinesBtn').addEventListener('click', function() {
            if (Object.keys(subjectLines).length === 0) {
                alert('没有学科分数线需要清空');
                return;
            }
            
            if (confirm('确定要清空所有学科分数线吗？')) {
                subjectLines = {};
                updateSubjectLinesDisplay();
            }
        });
        
        // 更新学科分数线显示
        function updateSubjectLinesDisplay() {
            const configDiv = document.getElementById('subjectLinesConfig');
            let html = '';
            
            if (Object.keys(subjectLines).length === 0) {
                html = '<p class="text-muted">暂无学科分数线（可选，如需设置请在下方的表单中添加）</p>';
            } else {
                for (const [lineName, subjects] of Object.entries(subjectLines)) {
                    const lineColor = lineName === '特控线' ? 'danger' : 'success';
                    html += `
                        <div class="card mb-2">
                            <div class="card-header bg-${lineColor} text-white py-2">
                                <strong>${lineName}学科分数线</strong>
                            </div>
                            <div class="card-body py-2">
                                ${Object.entries(subjects).map(([subject, score]) => `
                                    <span class="badge bg-info me-2 mb-1" style="font-size: 0.9rem;">
                                        ${subject}: ${score}分
                                        <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.7rem;" 
                                                onclick="removeSubjectLine('${lineName}', '${subject}')" aria-label="删除"></button>
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            configDiv.innerHTML = html;
        }
        
        // 删除单个学科分数线
        function removeSubjectLine(lineName, subject) {
            if (subjectLines[lineName] && subjectLines[lineName][subject]) {
                delete subjectLines[lineName][subject];
                // 如果该分数线类型下没有学科了，删除该类型
                if (Object.keys(subjectLines[lineName]).length === 0) {
                    delete subjectLines[lineName];
                }
                updateSubjectLinesDisplay();
            }
        }
        
        // 将removeSubjectLine函数暴露到全局作用域
        window.removeSubjectLine = removeSubjectLine;
        
        // 初始化显示
        updateScoreLinesDisplay();
        generateSubjectLinesInputs();
        updateSubjectLinesDisplay();
        
        
        // 文件上传（仅联盟全体数据）- 用按钮点击触发，避免表单 POST 到 /
        document.getElementById('uploadBtn').addEventListener('click', async function() {
            const leagueFile = document.getElementById('league_file').files[0];
            if (!leagueFile) {
                alert('请选择【联盟全体数据】文件');
                return;
            }
            
            const formData = new FormData();
            formData.append('league_file', leagueFile);
            
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<div class="alert alert-info">正在上传文件...</div>';
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                // 检查响应状态
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态: ${response.status}`);
                }
                
                // 尝试解析JSON
                let result;
                try {
                    result = await response.json();
                } catch (jsonError) {
                    const text = await response.text();
                    console.error('响应不是JSON格式:', text);
                    throw new Error('服务器响应格式错误');
                }
                
                console.log('上传响应:', result);
                
                if (result.success) {
                    statusDiv.innerHTML = '<div class="alert alert-success">文件上传成功！</div>';
                    uploadedFiles = {
                        school_path: null,
                        league_path: result.league_path || null
                    };
                    console.log('保存的文件路径:', uploadedFiles);
                    
                    // 学科列表来自联盟表头（语文、数学等）
                    if (result.subjects && result.subjects.length > 0) {
                        availableSubjects = result.subjects;
                    } else if (result.league_columns && result.league_columns.length > 0) {
                        const subjectCols = ['语文', '数学', '英语', '物理', '化学', '生物', '政治', '历史', '地理'];
                        availableSubjects = result.league_columns.filter(c => subjectCols.includes(String(c).trim()));
                        if (availableSubjects.length === 0) availableSubjects = [...subjectCols];
                    }
                    console.log('可用学科列表:', availableSubjects);
                    generateSubjectLinesInputs();
                    
                    // 显示分数线设置区域
                    const scoreLineCard = document.getElementById('scoreLineCard');
                    console.log('分数线设置区域元素:', scoreLineCard);
                    if (scoreLineCard) {
                        scoreLineCard.style.display = 'block';
                        console.log('已显示分数线设置区域');
                        // 滚动到分数线设置区域
                        setTimeout(() => {
                            scoreLineCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                } else {
                        console.error('找不到分数线设置区域元素 (id=scoreLineCard)');
                        statusDiv.innerHTML += '<div class="alert alert-warning mt-2">警告：找不到分数线设置区域，请刷新页面重试</div>';
                    }
                } else {
                    console.error('上传失败:', result.message);
                    statusDiv.innerHTML = `<div class="alert alert-danger">${result.message || '上传失败'}</div>`;
                }
            } catch (error) {
                console.error('上传过程出错:', error);
                statusDiv.innerHTML = `<div class="alert alert-danger">上传失败: ${error.message}</div>`;
            }
        });
        
        // 开始分析
        document.getElementById('analyzeBtn').addEventListener('click', async function() {
            const yiduanLine = parseFloat(document.getElementById('yiduanLine').value);
            const tekongLine = parseFloat(document.getElementById('tekongLine').value);
            
            if (isNaN(yiduanLine) || isNaN(tekongLine) || yiduanLine <= 0 || tekongLine <= 0) {
                alert('请设置一段线和特控线');
                return;
            }
            
            const schoolNames = getSchoolNames();
            if (!schoolNames.length) {
                alert('请至少填写一个学校名称或别名');
                return;
            }
            
            if (!uploadedFiles.league_path) {
                alert('请先上传【联盟全体数据】文件');
                return;
            }
            
            // 清空之前的结果和图表
            clearPreviousResults();
            
            this.disabled = true;
            this.textContent = '分析中...';
            
            try {
                analysisResults = {};
                
                // 1. 总分分析
                const scoreLines = [tekongLine, yiduanLine];
                let schoolTotalAnalysis = null;
                try {
                    const totalResponse = await fetch('/analyze_school_total', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            school_path: uploadedFiles.school_path,
                            league_path: uploadedFiles.league_path,
                            school_names: schoolNames,
                            score_lines: scoreLines
                        })
                    });
                    const totalResult = await totalResponse.json();
                    if (totalResult.success) {
                        schoolTotalAnalysis = totalResult.analysis;
                        analysisResults.schoolTotal = schoolTotalAnalysis;
                    }
                } catch (error) {
                    console.error('总分分析失败:', error);
                }
                
                // 2. 学科分数线分析
                let subjectLinesTekong = null;
                let subjectLinesYiduan = null;
                if (subjectLines['特控线'] && Object.keys(subjectLines['特控线']).length > 0) {
                    try {
                        const response = await fetch('/analyze_subject_lines', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                school_path: uploadedFiles.school_path,
                                league_path: uploadedFiles.league_path,
                                school_names: schoolNames,
                                total_score_line: tekongLine,
                                subject_score_lines: subjectLines['特控线']
                            })
                        });
                        const result = await response.json();
                        if (result.success) {
                            subjectLinesTekong = result.analysis;
                            analysisResults.subjectLinesTekong = subjectLinesTekong;
                        }
                    } catch (error) {
                        console.error('特控线学科分析失败:', error);
                    }
                }
                
                if (subjectLines['一段线'] && Object.keys(subjectLines['一段线']).length > 0) {
                    try {
                        const response = await fetch('/analyze_subject_lines', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                school_path: uploadedFiles.school_path,
                                league_path: uploadedFiles.league_path,
                                school_names: schoolNames,
                                total_score_line: yiduanLine,
                                subject_score_lines: subjectLines['一段线']
                            })
                        });
                        const result = await response.json();
                        if (result.success) {
                            subjectLinesYiduan = result.analysis;
                            analysisResults.subjectLinesYiduan = subjectLinesYiduan;
                        }
                    } catch (error) {
                        console.error('一段线学科分析失败:', error);
                    }
                }
                
                // 3. 班级各科情况表格
                let classSubjectsTekong = null;
                let classSubjectsYiduan = null;
                try {
                    const response1 = await fetch('/analyze_class_subjects', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            school_path: uploadedFiles.school_path,
                            league_path: uploadedFiles.league_path,
                            school_names: schoolNames,
                            score_line: tekongLine,
                            subject_score_lines: subjectLines['特控线'] || {}
                        })
                    });
                    const result1 = await response1.json();
                    if (result1.success) {
                        classSubjectsTekong = result1.analysis;
                        analysisResults.classSubjectsTekong = classSubjectsTekong;
                    }
                } catch (error) {
                    console.error('特控线班级各科分析失败:', error);
                }
                
                try {
                    const response2 = await fetch('/analyze_class_subjects', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            school_path: uploadedFiles.school_path,
                            league_path: uploadedFiles.league_path,
                            school_names: schoolNames,
                            score_line: yiduanLine,
                            subject_score_lines: subjectLines['一段线'] || {}
                        })
                    });
                    const result2 = await response2.json();
                    if (result2.success) {
                        classSubjectsYiduan = result2.analysis;
                        analysisResults.classSubjectsYiduan = classSubjectsYiduan;
                    }
                } catch (error) {
                    console.error('一段线班级各科分析失败:', error);
                }
                
                // 4. 班级考核分
                let classAssessment = null;
                let excludedStudents = null;
                try {
                    const response = await fetch('/calculate_class_assessment', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            school_path: uploadedFiles.school_path,
                            league_path: uploadedFiles.league_path,
                            school_names: schoolNames,
                            tekong_line: tekongLine,
                            yiduan_line: yiduanLine
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        classAssessment = result.results && result.results.class_results ? result.results.class_results : [];
                        excludedStudents = result.results && result.results.excluded_students ? result.results.excluded_students : [];
                        analysisResults.classAssessment = classAssessment;
                        analysisResults.classAssessmentExcluded = excludedStudents;
                    }
                } catch (error) {
                    console.error('班级考核分计算失败:', error);
                }
                
                // 5. 联盟对比（我校与各校过线率、我校排名、我校各科排名、学科过线率排名）
                let leagueAnalysis = null;
                try {
                    const leagueRes = await fetch('/analyze_league', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            league_path: uploadedFiles.league_path,
                            school_names: schoolNames,
                            score_lines: [tekongLine, yiduanLine],
                            subject_lines: subjectLines && Object.keys(subjectLines).length > 0 ? subjectLines : undefined
                        })
                    });
                    const leagueData = await leagueRes.json();
                    if (leagueData.success && leagueData.league_analysis) {
                        leagueAnalysis = leagueData.league_analysis;
                        analysisResults.leagueAnalysis = leagueAnalysis;
                    }
                } catch (error) {
                    console.error('联盟对比分析失败:', error);
                }
                
                // 显示结果
                displayNewResults(schoolTotalAnalysis, subjectLinesTekong, subjectLinesYiduan, 
                                 classSubjectsTekong, classSubjectsYiduan, classAssessment,
                                 excludedStudents, tekongLine, yiduanLine, leagueAnalysis);
                
                // 显示导出与快照按钮
                document.getElementById('exportBtn').style.display = 'inline-block';
                var snapBtn = document.getElementById('snapshotBtn');
                if (snapBtn) snapBtn.style.display = 'inline-block';
                
                const resultsArea = document.getElementById('resultsArea');
                if (resultsArea) {
                    resultsArea.style.display = 'block';
                    setTimeout(() => {
                        resultsArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
            } catch (error) {
                console.error('分析过程出错:', error);
                alert('分析失败: ' + error.message);
            } finally {
                this.disabled = false;
                this.textContent = '开始分析';
            }
        });
        
        // 清空之前的结果
        function clearPreviousResults() {
            try {
                // 销毁所有已存在的echarts实例（在清空HTML之前）
                if (window.subjectDataMap) {
                    Object.keys(window.subjectDataMap).forEach(subjectId => {
                        try {
                            const container = document.getElementById('chart_' + subjectId);
                            if (container) {
                                const chart = echarts.getInstanceByDom(container);
                                if (chart) {
                                    chart.dispose();
                                }
                            }
                        } catch (e) {
                            console.warn('销毁科目图表失败:', e);
                        }
                    });
                }
                
                // 销毁联盟图表的实例
                try {
                    document.querySelectorAll('[id^="league_chart_"]').forEach(container => {
                        try {
                            const chart = echarts.getInstanceByDom(container);
                            if (chart) {
                                chart.dispose();
                            }
                        } catch (e) {
                            console.warn('销毁联盟图表失败:', e);
                        }
                    });
                } catch (e) {
                    console.warn('查询联盟图表容器失败:', e);
                }
                
                // 清空数据映射
                window.subjectDataMap = {};
                window.classDetailCache = {}; // 清空缓存
                
                // 清空结果区域
                const schoolDiv = document.getElementById('schoolAnalysisResults');
                const leagueDiv = document.getElementById('leagueAnalysisResults');
                const schoolTotalDiv = document.getElementById('schoolTotalAnalysisResults');
                const schoolSubjectsDiv = document.getElementById('schoolSubjectsAnalysisResults');
                if (schoolDiv) {
                    schoolDiv.innerHTML = '';
                }
                if (leagueDiv) {
                    leagueDiv.innerHTML = '';
                }
                if (schoolTotalDiv) {
                    schoolTotalDiv.innerHTML = '';
                }
                if (schoolSubjectsDiv) {
                    schoolSubjectsDiv.innerHTML = '';
                }
                
                // 销毁我校总分分析图表
                try {
                    document.querySelectorAll('[id^="school_total_chart_"]').forEach(container => {
                        try {
                            const chart = echarts.getInstanceByDom(container);
                            if (chart) {
                                chart.dispose();
                            }
                        } catch (e) {
                            console.warn('销毁我校总分图表失败:', e);
                        }
                    });
                } catch (e) {
                    console.warn('查询我校总分图表容器失败:', e);
                }
                
                // 销毁班级考核结果图表
                try {
                    document.querySelectorAll('[id^="class_assessment_chart_"]').forEach(container => {
                        try {
                            const chart = echarts.getInstanceByDom(container);
                            if (chart) {
                                chart.dispose();
                            }
                        } catch (e) {
                            console.warn('销毁班级考核图表失败:', e);
                        }
                    });
                } catch (e) {
                    console.warn('查询班级考核图表容器失败:', e);
                }
                
                // 销毁学科分数线图表
                try {
                    document.querySelectorAll('[id^="subject_line_chart_"]').forEach(container => {
                        try {
                            const chart = echarts.getInstanceByDom(container);
                            if (chart) {
                                chart.dispose();
                            }
                        } catch (e) {
                            console.warn('销毁学科分数线图表失败:', e);
                        }
                    });
                } catch (e) {
                    console.warn('查询学科分数线图表容器失败:', e);
                }
                
                // 销毁总分分析图表
                try {
                    document.querySelectorAll('[id^="total_score_chart_"]').forEach(container => {
                        try {
                            const chart = echarts.getInstanceByDom(container);
                            if (chart) {
                                chart.dispose();
                            }
                        } catch (e) {
                            console.warn('销毁总分分析图表失败:', e);
                        }
                    });
                } catch (e) {
                    console.warn('查询总分分析图表容器失败:', e);
                }
                
                // 销毁班级各科情况图表
                try {
                    document.querySelectorAll('[id^="class_subjects_chart_"]').forEach(container => {
                        try {
                            const chart = echarts.getInstanceByDom(container);
                            if (chart) {
                                chart.dispose();
                            }
                        } catch (e) {
                            console.warn('销毁班级各科情况图表失败:', e);
                        }
                    });
                } catch (e) {
                    console.warn('查询班级各科情况图表容器失败:', e);
                }
            } catch (e) {
                console.error('清空结果失败:', e);
            }
        }
        
        // 以下为旧版展示逻辑：依赖 schoolSubjectsAnalysisResults / schoolTotalAnalysisResults / leagueAnalysisResults 等容器。
        // 当前「开始分析」仅使用 displayNewResults，此处保留供日后需要展示联盟排名、我校各科班级对比时复用（可调用 /analyze 获取数据后传入）。
        function displayResults(schoolAnalysis, leagueAnalysis, scoreLinesList, schoolTotalAnalysis = null, schoolSubjectsAnalysis = null) {
            if (!document.getElementById('schoolSubjectsAnalysisResults')) return; // 当前页面未使用该展示容器，直接返回
            // 创建分数到名称的映射
            const scoreToName = {};
            scoreLinesList.forEach(line => {
                scoreToName[line.score] = line.name;
            });
            
            // 显示我校各学科班级对比分析结果
            const schoolSubjectsDiv = document.getElementById('schoolSubjectsAnalysisResults');
            let schoolSubjectsHTML = '';
            
            if (!schoolSubjectsAnalysis || Object.keys(schoolSubjectsAnalysis).length === 0) {
                schoolSubjectsHTML = '<div class="alert alert-warning">没有找到我校数据，请检查【联盟全体数据】中学校名称是否与所填一致</div>';
            } else {
                // 按语数英物化生政史地顺序显示学科
                let subjectIndex = 0;
                for (const subject of sortSubjects(Object.keys(schoolSubjectsAnalysis))) {
                    const data = schoolSubjectsAnalysis[subject];
                    // 生成唯一的图表ID：使用索引 + 学科名称的简单编码
                    const chartId = `subject_chart_${subjectIndex}_${encodeURIComponent(subject).replace(/[^a-zA-Z0-9]/g, '_')}`;
                    subjectIndex++;
                    
                    schoolSubjectsHTML += `
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">${subject}</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <h3>${data.total_students}</h3>
                                        <p>总人数</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <h3>${data.average_score}</h3>
                                        <p>平均分</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <h3>${data.max_score}</h3>
                                        <p>最高分</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <h3>${data.min_score}</h3>
                                        <p>最低分</p>
                                    </div>
                                </div>
                            </div>
                            
                            ${data.class_stats && data.class_stats.length > 0 ? `
                            <h6>各班级对比（按平均分排序）</h6>
                            <div class="table-responsive mb-3">
                                <table class="table table-striped table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>班级</th>
                                            <th>人数</th>
                                            <th>平均分</th>
                                            <th>最高分</th>
                                            <th>最低分</th>
                                            <th>中位数</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.class_stats.map(stat => `
                                            <tr>
                                                <td><strong>${stat.class_name}</strong></td>
                                                <td>${stat.total_students}</td>
                                                <td><strong>${stat.average_score}</strong></td>
                                                <td>${stat.max_score}</td>
                                                <td>${stat.min_score}</td>
                                                <td>${stat.median_score || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="chart-container" id="${chartId}" style="height: 400px;"></div>
                            ` : '<div class="alert alert-info">暂无班级数据</div>'}
                        </div>
                    </div>
                `;
                }
            }
            
            schoolSubjectsDiv.innerHTML = schoolSubjectsHTML;
            
            // 创建各学科班级对比图表（在HTML渲染后，按语数英物化生政史地顺序）
            if (schoolSubjectsAnalysis && Object.keys(schoolSubjectsAnalysis).length > 0) {
                setTimeout(() => {
                    let subjectIndex = 0;
                    for (const subject of sortSubjects(Object.keys(schoolSubjectsAnalysis))) {
                        const data = schoolSubjectsAnalysis[subject];
                        if (data.class_stats && data.class_stats.length > 0) {
                            // 使用相同的ID生成逻辑
                            const chartId = `subject_chart_${subjectIndex}_${encodeURIComponent(subject).replace(/[^a-zA-Z0-9]/g, '_')}`;
                            console.log(`创建图表: ${chartId} for ${subject}`);
                            createSubjectClassChart(chartId, subject, data.class_stats);
                            subjectIndex++;
                        }
                    }
                }, 300);
            }
            
            // 显示我校总分分析结果
            const schoolTotalDiv = document.getElementById('schoolTotalAnalysisResults');
            let schoolTotalHTML = '';
            
            if (!schoolTotalAnalysis || Object.keys(schoolTotalAnalysis).length === 0) {
                schoolTotalHTML = '<div class="alert alert-warning">没有找到我校数据，请先上传【联盟我校数据】文件</div>';
            } else {
                for (const [key, data] of Object.entries(schoolTotalAnalysis)) {
                    const lineName = scoreToName[data.score_line] || `分数线${data.score_line}`;
                    schoolTotalHTML += `
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">${lineName} (${data.score_line}分)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <h3>${data.passed_count}/${data.total_students}</h3>
                                        <p>过线人数/总人数</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <h3>${data.pass_rate}%</h3>
                                        <p>过线率（特控线率）</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <h3>${data.average_score}</h3>
                                        <p>全校平均分</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <h3>${data.passed_avg_score}</h3>
                                        <p>过线学生平均分</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="alert alert-info">
                                        <strong>最高分：</strong>${data.max_score}分<br/>
                                        <strong>最低分：</strong>${data.min_score}分<br/>
                                        <strong>中位数：</strong>${data.median_score}分
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="alert alert-warning">
                                        <strong>未过线人数：</strong>${data.not_passed_count}人<br/>
                                        <strong>未过线平均分：</strong>${data.not_passed_avg_score}分
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="alert alert-secondary">
                                        <strong>标准差：</strong>${data.std_score}<br/>
                                        <strong>过线学生平均分：</strong>${data.passed_avg_score}分
                                    </div>
                                </div>
                            </div>
                            
                            <h6>过线学生班级分布</h6>
                            <div class="mb-3">
                                ${data.class_distribution && Object.keys(data.class_distribution).length > 0 ? 
                                    Object.entries(data.class_distribution).map(([cls, count]) => 
                                        `<span class="badge bg-primary me-2">${cls}班: ${count}人</span>`
                                    ).join('') : 
                                    '<span class="text-muted">无数据</span>'
                                }
                            </div>
                            
                            ${data.class_stats && data.class_stats.length > 0 ? `
                            <h6>各班级过线情况统计</h6>
                            <div class="table-responsive mb-3">
                                <table class="table table-striped table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>班级</th>
                                            <th>总人数</th>
                                            <th>过线人数</th>
                                            <th>过线率</th>
                                            <th>班级平均分</th>
                                            <th>过线学生平均分</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.class_stats.map(stat => `
                                            <tr>
                                                <td>${stat.class_name}</td>
                                                <td>${stat.total_students}</td>
                                                <td>${stat.passed_count}</td>
                                                <td><strong>${stat.pass_rate}%</strong></td>
                                                <td>${stat.average_score}</td>
                                                <td>${stat.passed_avg_score}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="chart-container mb-3" id="school_total_chart_${data.score_line}" style="height: 400px;"></div>
                            ` : ''}
                        </div>
                    </div>
                `;
                }
            }
            
            schoolTotalDiv.innerHTML = schoolTotalHTML;
            
            // 创建我校总分分析图表（在HTML渲染后）
            if (schoolTotalAnalysis && Object.keys(schoolTotalAnalysis).length > 0) {
                setTimeout(() => {
                    for (const [key, data] of Object.entries(schoolTotalAnalysis)) {
                        const lineName = scoreToName[data.score_line] || `分数线${data.score_line}`;
                        if (data.class_stats && data.class_stats.length > 0) {
                            createSchoolTotalChart(`school_total_chart_${data.score_line}`, data, lineName);
                        }
                    }
                }, 150);
            }
            
            // 显示联盟分析结果（使用已创建的 scoreToName 映射）
            const leagueDiv = document.getElementById('leagueAnalysisResults');
            let leagueHTML = '';
            
            if (!leagueAnalysis || Object.keys(leagueAnalysis).length === 0) {
                leagueHTML = '<div class="alert alert-warning">没有找到联盟数据，请检查文件格式</div>';
            } else {
                for (const [key, data] of Object.entries(leagueAnalysis)) {
                    const lineName = scoreToName[data.score_line] || `分数线${data.score_line}`;
                    leagueHTML += `
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">${lineName} (${data.score_line}分)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="stat-card">
                                        <h3>${data.league_passed_count}/${data.league_total}</h3>
                                        <p>联盟过线人数/总人数</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stat-card">
                                        <h3>${data.league_pass_rate}%</h3>
                                        <p>联盟过线率</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stat-card">
                                        <h3>${data.school_passed_count}/${data.school_total}</h3>
                                        <p>我校过线人数/总人数</p>
                                    </div>
                                </div>
                            </div>
                            
                            ${data.school_rank ? `<div class="alert alert-info"><strong>我校的线在各校的排名：</strong>第 ${data.school_rank} 名</div>` : ''}
                            
                            ${data.school_subject_ranks && Object.keys(data.school_subject_ranks).length > 0 ? `
                            <h6>我校各学科在各校之间的排名</h6>
                            <div class="table-responsive mb-3">
                                <table class="table table-striped table-sm">
                                    <thead><tr><th>学科</th><th>我校排名</th><th>我校平均分</th></tr></thead>
                                    <tbody>
                                        ${sortSubjects(Object.keys(data.school_subject_ranks)).map(subj => {
                                            const rank = data.school_subject_ranks[subj];
                                            const avg = (data.school_subject_averages && data.school_subject_averages[subj] != null) ? data.school_subject_averages[subj] : '-';
                                            return `<tr><td>${subj}</td><td><strong>第 ${rank} 名</strong></td><td>${avg}</td></tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                            ` : ''}
                            
                            <h6>我校过线学生班级分布</h6>
                            <div class="mb-3">
                                ${data.school_class_distribution && Object.keys(data.school_class_distribution).length > 0 ? 
                                    Object.entries(data.school_class_distribution).map(([cls, count]) => 
                                        `<span class="badge bg-primary me-2">${cls}班: ${count}人</span>`
                                    ).join('') : 
                                    '<span class="text-muted">无数据（可能学校名称不匹配或没有过线学生）</span>'
                                }
                            </div>
                            
                            ${data.school_class_pass_stats && data.school_class_pass_stats.length > 0 ? `
                            <h6>我校各班级特控率详情</h6>
                            <div class="table-responsive mb-3">
                                <table class="table table-striped table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>班级</th>
                                            <th>总人数</th>
                                            <th>过线人数</th>
                                            <th>过线率</th>
                                            <th>平均分</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.school_class_pass_stats.map(stat => {
                                            const tooltipHtml = `
                                                <div style="text-align: left;">
                                                    <strong>${stat.class_name}班详细信息</strong><br/>
                                                    总人数：${stat.total_students}人<br/>
                                                    过线人数：${stat.passed_count}人<br/>
                                                    未过线人数：${stat.total_students - stat.passed_count}人<br/>
                                                    过线率：<strong>${stat.pass_rate}%</strong><br/>
                                                    平均分：${stat.average_score}分
                                                </div>
                                            `;
                                            return `
                                            <tr data-bs-toggle="tooltip" 
                                                data-bs-placement="top"
                                                data-bs-html="true"
                                                data-bs-title="${tooltipHtml.replace(/"/g, '&quot;').replace(/\n/g, '').replace(/\s+/g, ' ')}"
                                                style="cursor: pointer;">
                                                <td>${stat.class_name}班</td>
                                                <td>${stat.total_students}</td>
                                                <td>${stat.passed_count}</td>
                                                <td><strong>${stat.pass_rate}%</strong></td>
                                                <td>${stat.average_score}</td>
                                            </tr>
                                        `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="chart-container mb-3" id="class_pass_chart_${data.score_line}" style="height: 400px;"></div>
                            ` : ''}
                            
                            <h6>各校过线情况排名</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>排名</th>
                                            <th>学校</th>
                                            <th>总人数</th>
                                            <th>过线人数</th>
                                            <th>过线率</th>
                                            <th>平均分</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.school_stats.map((stat, idx) => {
                                            const schoolName = document.getElementById('school_name').value.trim();
                                            const schoolAlias = document.getElementById('school_alias').value.trim();
                                            const matchName = schoolAlias || schoolName;
                                            const isMatch = stat.school_name === matchName || stat.school_name.includes(matchName) || matchName.includes(stat.school_name);
                                            return `
                                            <tr ${isMatch ? 'class="table-warning"' : ''}>
                                                <td>${idx + 1}</td>
                                                <td>${stat.school_name}</td>
                                                <td>${stat.total_students}</td>
                                                <td>${stat.passed_count}</td>
                                                <td>${stat.pass_rate}%</td>
                                                <td>${stat.average_score}</td>
                                            </tr>
                                        `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="chart-container" id="league_chart_${data.score_line}"></div>
                        </div>
                    </div>
                `;
                
                // 创建联盟图表
                    setTimeout(() => {
                        const lineName = scoreToName[data.score_line] || `分数线${data.score_line}`;
                        createLeagueChart(`league_chart_${data.score_line}`, data, lineName);
                        
                        // 创建班级特控率图表
                        if (data.school_class_pass_stats && data.school_class_pass_stats.length > 0) {
                            createClassPassChart(`class_pass_chart_${data.score_line}`, data.school_class_pass_stats, lineName);
                            
                            // 初始化Bootstrap tooltip
                            setTimeout(() => {
                                const tooltipTriggerList = document.querySelectorAll(`[data-bs-toggle="tooltip"]`);
                                tooltipTriggerList.forEach(tooltipTriggerEl => {
                                    // 先销毁旧的tooltip实例（如果存在）
                                    const existingTooltip = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
                                    if (existingTooltip) {
                                        existingTooltip.dispose();
                                    }
                                    // 创建新的tooltip实例
                                    new bootstrap.Tooltip(tooltipTriggerEl);
                                });
                            }, 200);
                        }
                    }, 150);
                }
            }
            
            leagueDiv.innerHTML = leagueHTML;
        }
        
        
        // 创建联盟图表
        function createLeagueChart(containerId, data, lineName) {
            const chart = echarts.init(document.getElementById(containerId));
            
            // 取前10名学校
            const topSchools = data.school_stats.slice(0, 10);
            
            const option = {
                title: {
                    text: `各校过线率排名（${lineName}: ${data.score_line}分）`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                xAxis: {
                    type: 'category',
                    data: topSchools.map(s => s.school_name),
                    axisLabel: {
                        rotate: 45,
                        interval: 0
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '过线率(%)'
                },
                series: [
                    {
                        name: '过线率',
                        type: 'bar',
                        data: topSchools.map(s => s.pass_rate),
                        itemStyle: {
                            color: function(params) {
                                return params.dataIndex < 3 ? '#ff6b6b' : '#4ecdc4';
                            }
                        }
                    }
                ]
            };
            
            chart.setOption(option);
        }
        
        // 创建班级特控率图表
        function createClassPassChart(containerId, classStats, lineName) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`容器 ${containerId} 不存在`);
                return;
            }
            
            // 检查是否已有echarts实例，如果有先销毁
            const existingChart = echarts.getInstanceByDom(container);
            if (existingChart) {
                existingChart.dispose();
            }
            
            // 清空容器
            container.innerHTML = '';
            
            // 准备数据
            const classNames = classStats.map(stat => stat.class_name + '班');
            const passRates = classStats.map(stat => stat.pass_rate);
            const passedCounts = classStats.map(stat => stat.passed_count);
            const totalCounts = classStats.map(stat => stat.total_students);
            const avgScores = classStats.map(stat => stat.average_score);
            
            // 创建图表实例
            const chart = echarts.init(container);
            
            const option = {
                title: {
                    text: `我校各班级特控率情况 - ${lineName}`,
                    left: 'center',
                    textStyle: {
                        fontSize: 16
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function(params) {
                        let result = params[0].name + '<br/>';
                        params.forEach(function(item) {
                            const index = item.dataIndex;
                            result += item.marker + item.seriesName + ': ' + item.value;
                            if (item.seriesName === '过线率') {
                                result += '%<br/>';
                                result += '&nbsp;&nbsp;过线人数: ' + passedCounts[index] + '人<br/>';
                                result += '&nbsp;&nbsp;总人数: ' + totalCounts[index] + '人<br/>';
                                result += '&nbsp;&nbsp;平均分: ' + avgScores[index] + '分';
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['过线率', '平均分'],
                    bottom: 10
                },
                xAxis: {
                    type: 'category',
                    data: classNames,
                    axisLabel: {
                        rotate: 45,
                        interval: 0
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '过线率(%)',
                        position: 'left',
                        min: 0,
                        max: 100,
                        axisLabel: {
                            formatter: '{value}%'
                        }
                    },
                    {
                        type: 'value',
                        name: '平均分',
                        position: 'right',
                        axisLabel: {
                            formatter: '{value}'
                        }
                    }
                ],
                series: [
                    {
                        name: '过线率',
                        type: 'bar',
                        data: passRates,
                        itemStyle: {
                            color: function(params) {
                                // 根据过线率设置颜色：高过线率用红色，中等用橙色，低用蓝色
                                const rate = params.value;
                                if (rate >= 80) return '#ff6b6b';
                                if (rate >= 60) return '#ffa500';
                                if (rate >= 40) return '#4ecdc4';
                                return '#95a5a6';
                            }
                        },
                        label: {
                            show: true,
                            position: 'top',
                            formatter: '{c}%'
                        }
                    },
                    {
                        name: '平均分',
                        type: 'line',
                        yAxisIndex: 1,
                        data: avgScores,
                        itemStyle: {
                            color: '#95e1d3'
                        },
                        lineStyle: {
                            width: 3
                        },
                        label: {
                            show: true,
                            position: 'top',
                            formatter: '{c}'
                        },
                        symbol: 'circle',
                        symbolSize: 8
                    }
                ]
            };
            
            chart.setOption(option);
            
            // 响应式调整
            setTimeout(() => {
                chart.resize();
            }, 50);
        }
        
        // 创建我校总分分析图表
        function createSchoolTotalChart(containerId, data, lineName) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`容器 ${containerId} 不存在`);
                return;
            }
            
            // 检查是否已有echarts实例，如果有先销毁
            const existingChart = echarts.getInstanceByDom(container);
            if (existingChart) {
                existingChart.dispose();
            }
            
            // 清空容器
            container.innerHTML = '';
            
            if (!data.class_stats || data.class_stats.length === 0) {
                return;
            }
            
            // 准备数据
            const classNames = data.class_stats.map(stat => stat.class_name + '班');
            const passRates = data.class_stats.map(stat => stat.pass_rate);
            const passedCounts = data.class_stats.map(stat => stat.passed_count);
            const totalCounts = data.class_stats.map(stat => stat.total_students);
            const avgScores = data.class_stats.map(stat => stat.average_score);
            const passedAvgScores = data.class_stats.map(stat => stat.passed_avg_score);
            
            // 创建图表实例
            const chart = echarts.init(container);
            
            const option = {
                title: {
                    text: `我校各班级过线情况 - ${lineName}`,
                    left: 'center',
                    textStyle: {
                        fontSize: 16
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function(params) {
                        let result = params[0].name + '<br/>';
                        params.forEach(function(item) {
                            const index = item.dataIndex;
                            result += item.marker + item.seriesName + ': ' + item.value;
                            if (item.seriesName === '过线率') {
                                result += '%<br/>';
                                result += '&nbsp;&nbsp;过线人数: ' + passedCounts[index] + '人<br/>';
                                result += '&nbsp;&nbsp;总人数: ' + totalCounts[index] + '人<br/>';
                                result += '&nbsp;&nbsp;班级平均分: ' + avgScores[index] + '分<br/>';
                                result += '&nbsp;&nbsp;过线学生平均分: ' + passedAvgScores[index] + '分';
                            } else {
                                result += '分';
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['过线率', '班级平均分', '过线学生平均分'],
                    bottom: 10
                },
                xAxis: {
                    type: 'category',
                    data: classNames,
                    axisLabel: {
                        rotate: 45,
                        interval: 0
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '过线率(%)',
                        position: 'left',
                        min: 0,
                        max: 100,
                        axisLabel: {
                            formatter: '{value}%'
                        }
                    },
                    {
                        type: 'value',
                        name: '平均分',
                        position: 'right',
                        axisLabel: {
                            formatter: '{value}'
                        }
                    }
                ],
                series: [
                    {
                        name: '过线率',
                        type: 'bar',
                        data: passRates,
                        itemStyle: {
                            color: function(params) {
                                // 根据过线率设置颜色：高过线率用红色，中等用橙色，低用蓝色
                                const rate = params.value;
                                if (rate >= 80) return '#ff6b6b';
                                if (rate >= 60) return '#ffa500';
                                if (rate >= 40) return '#4ecdc4';
                                return '#95a5a6';
                            }
                        },
                        label: {
                            show: true,
                            position: 'top',
                            formatter: '{c}%'
                        }
                    },
                    {
                        name: '班级平均分',
                        type: 'line',
                        yAxisIndex: 1,
                        data: avgScores,
                        itemStyle: {
                            color: '#95e1d3'
                        },
                        lineStyle: {
                            width: 3
                        },
                        label: {
                            show: true,
                            position: 'top',
                            formatter: '{c}'
                        },
                        symbol: 'circle',
                        symbolSize: 8
                    },
                    {
                        name: '过线学生平均分',
                        type: 'line',
                        yAxisIndex: 1,
                        data: passedAvgScores,
                        itemStyle: {
                            color: '#f38181'
                        },
                        lineStyle: {
                            width: 3,
                            type: 'dashed'
                        },
                        label: {
                            show: true,
                            position: 'top',
                            formatter: '{c}'
                        },
                        symbol: 'diamond',
                        symbolSize: 8
                    }
                ]
            };
            
            chart.setOption(option);
            
            // 响应式调整
            setTimeout(() => {
                chart.resize();
            }, 50);
        }
        
        // 创建学科班级对比图表
        function createSubjectClassChart(containerId, subjectName, classStats) {
            console.log(`尝试创建图表: ${containerId} for ${subjectName}`);
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`容器 ${containerId} 不存在`);
                return;
            }
            console.log(`找到容器: ${containerId}`);
            
            // 检查是否已有echarts实例，如果有先销毁
            const existingChart = echarts.getInstanceByDom(container);
            if (existingChart) {
                existingChart.dispose();
            }
            
            // 清空容器
            container.innerHTML = '';
            
            if (!classStats || classStats.length === 0) {
                return;
            }
            
            // 准备数据
            const classNames = classStats.map(stat => stat.class_name + '班');
            const avgScores = classStats.map(stat => stat.average_score);
            const maxScores = classStats.map(stat => stat.max_score);
            const minScores = classStats.map(stat => stat.min_score);
            const medianScores = classStats.map(stat => stat.median_score || 0);
            
            // 创建图表实例
            const chart = echarts.init(container);
            
            const option = {
                title: {
                    text: `${subjectName} - 各班级成绩对比`,
                    left: 'center',
                    textStyle: {
                        fontSize: 16
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function(params) {
                        let result = params[0].name + '<br/>';
                        params.forEach(function(item) {
                            const index = item.dataIndex;
                            result += item.marker + item.seriesName + ': ' + item.value;
                            if (item.seriesName === '平均分' || item.seriesName === '最高分' || item.seriesName === '最低分' || item.seriesName === '中位数') {
                                result += '分<br/>';
                            }
                            if (item.seriesName === '平均分') {
                                result += '&nbsp;&nbsp;最高分: ' + maxScores[index] + '分<br/>';
                                result += '&nbsp;&nbsp;最低分: ' + minScores[index] + '分<br/>';
                                result += '&nbsp;&nbsp;中位数: ' + medianScores[index] + '分';
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['平均分', '最高分', '最低分', '中位数'],
                    bottom: 10
                },
                xAxis: {
                    type: 'category',
                    data: classNames,
                    axisLabel: {
                        rotate: 45,
                        interval: 0
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '分数',
                    axisLabel: {
                        formatter: '{value}'
                    }
                },
                series: [
                    {
                        name: '平均分',
                        type: 'bar',
                        data: avgScores,
                        itemStyle: {
                            color: '#4ecdc4'
                        },
                        label: {
                            show: true,
                            position: 'top',
                            formatter: '{c}'
                        }
                    },
                    {
                        name: '最高分',
                        type: 'line',
                        data: maxScores,
                        itemStyle: {
                            color: '#ff6b6b'
                        },
                        lineStyle: {
                            width: 2
                        },
                        symbol: 'circle',
                        symbolSize: 6,
                        label: {
                            show: true,
                            position: 'top',
                            formatter: '{c}'
                        }
                    },
                    {
                        name: '最低分',
                        type: 'line',
                        data: minScores,
                        itemStyle: {
                            color: '#95a5a6'
                        },
                        lineStyle: {
                            width: 2
                        },
                        symbol: 'circle',
                        symbolSize: 6,
                        label: {
                            show: true,
                            position: 'bottom',
                            formatter: '{c}'
                        }
                    },
                    {
                        name: '中位数',
                        type: 'line',
                        data: medianScores,
                        itemStyle: {
                            color: '#f39c12'
                        },
                        lineStyle: {
                            width: 2,
                            type: 'dashed'
                        },
                        symbol: 'diamond',
                        symbolSize: 8,
                        label: {
                            show: true,
                            position: 'top',
                            formatter: '{c}'
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            
            // 响应式调整
            setTimeout(() => {
                chart.resize();
            }, 50);
        }
        
        // 显示新的分析结果
        function displayNewResults(schoolTotalAnalysis, subjectLinesTekong, subjectLinesYiduan,
                                 classSubjectsTekong, classSubjectsYiduan, classAssessment,
                                 excludedStudents, tekongLine, yiduanLine, leagueAnalysis) {
            const resultsArea = document.getElementById('resultsArea');
            let html = '';
            
            // 1. 班级考核结果
            if (classAssessment && classAssessment.length > 0) {
                const assessmentChartId = `class_assessment_chart_${Date.now()}`;
                html += `
                    <div class="card mb-3 result-section-card">
                        <div class="card-header result-section-header result-section-header-primary">
                            <h5 class="mb-0">一、班级考核结果</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>排名</th>
                                            <th>班级</th>
                                            <th>总人数</th>
                                            <th>特控过线人数</th>
                                            <th>特控率(%)</th>
                                            <th>一段过线人数</th>
                                            <th>一段率(%)</th>
                                            <th>考核分</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${classAssessment.map(item => `
                                            <tr>
                                                <td>${item.rank}</td>
                                            <td><strong>${item.class_name}</strong></td>
                                                <td>${item.total_students}</td>
                                                <td>${item.tekong_passed}</td>
                                                <td>${item.tekong_rate}</td>
                                                <td>${item.yiduan_passed}</td>
                                                <td>${item.yiduan_rate}</td>
                                                <td><strong>${item.assessment_score}</strong></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="chart-container mt-3" id="${assessmentChartId}" style="height: 500px;"></div>
                        </div>
                    </div>
                `;
                
                // 渲染班级考核结果图表
                setTimeout(() => {
                    createClassAssessmentChart(assessmentChartId, classAssessment);
                }, 100);
            }
            
            // 1.1 缺考或被剔除学生列表
            if (excludedStudents && excludedStudents.length > 0) {
                html += `
                    <div class="card mb-3 result-section-card">
                        <div class="card-header result-section-header result-section-header-warning">
                            <h5 class="mb-0">未纳入班级考核的学生（缺考或成绩异常）</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>班级</th>
                                            <th>姓名</th>
                                            <th>原因</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${excludedStudents.map(item => `
                                            <tr>
                                                <td>${item.班级 || ''}</td>
                                                <td>${item.姓名 || ''}</td>
                                                <td>${item.原因 || '缺考或成绩缺失'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 2. 班级各科过线情况（特控线+一段线合并为一个卡片，按钮切换）
            if ((classSubjectsTekong && classSubjectsTekong.classes) || (classSubjectsYiduan && classSubjectsYiduan.classes)) {
                html += createUnifiedClassSubjectsSection(classSubjectsTekong, classSubjectsYiduan, tekongLine, yiduanLine);
            }
            
            // 3. 学科分数线详情（特控线+一段线合并为一个卡片，按钮切换）
            if ((subjectLinesTekong && subjectLinesTekong.subjects) || (subjectLinesYiduan && subjectLinesYiduan.subjects)) {
                html += createUnifiedSubjectLinesSection(subjectLinesTekong, subjectLinesYiduan);
            }
            
            // 6. 总分分析
            if (schoolTotalAnalysis) {
                html += createTotalScoreAnalysis(schoolTotalAnalysis, tekongLine, yiduanLine);
            }
            
            // 7. 我校与各校对比（联盟过线率、我校排名、我校各科排名）
            if (leagueAnalysis && Object.keys(leagueAnalysis).length > 0) {
                html += createLeagueComparisonSection(leagueAnalysis, tekongLine, yiduanLine);
            }
            
            resultsArea.innerHTML = html;
        }
        
        // 各校对比总表 + 各学科平均分/特控/一段表格（参考人数、特控率排名、一段率排名、平均分及学科明细）
        function createLeagueSchoolComparisonTables(leagueAnalysis, tekongLine, yiduanLine, subjectLineRankings) {
            const lineKey = function(score) {
                if (score == null || score === '') return null;
                const n = Number(score);
                if (isNaN(n)) return null;
                const k1 = 'line_' + n;
                const k2 = (n === Math.floor(n)) ? ('line_' + n + '.0') : null;
                return leagueAnalysis[k1] ? k1 : (k2 && leagueAnalysis[k2] ? k2 : null);
            };
            const keyTekong = lineKey(tekongLine);
            const keyYiduan = lineKey(yiduanLine);
            const dataTekong = keyTekong ? leagueAnalysis[keyTekong] : null;
            const dataYiduan = keyYiduan ? leagueAnalysis[keyYiduan] : null;
            if (!dataTekong && !dataYiduan) return '';
            const statsTekong = (dataTekong && dataTekong.school_stats) ? dataTekong.school_stats : [];
            const statsYiduan = (dataYiduan && dataYiduan.school_stats) ? dataYiduan.school_stats : [];
            const schoolList = statsTekong.length ? statsTekong.map(s => s.school_name) : statsYiduan.map(s => s.school_name);
            if (!schoolList.length) return '';

            const bySchool = {};
            schoolList.forEach(name => { bySchool[name] = {}; });
            statsTekong.forEach(s => {
                if (!bySchool[s.school_name]) return;
                bySchool[s.school_name].ref_count = s.total_students;
                bySchool[s.school_name].tekong_passed = s.passed_count;
                bySchool[s.school_name].tekong_rate = s.pass_rate;
                bySchool[s.school_name].tekong_rank = s.pass_rate_rank != null ? s.pass_rate_rank : '-';
                bySchool[s.school_name].avg_score = s.average_score;
                bySchool[s.school_name].avg_rank = s.avg_score_rank != null ? s.avg_score_rank : '-';
            });
            statsYiduan.forEach(s => {
                if (!bySchool[s.school_name]) return;
                bySchool[s.school_name].yiduan_passed = s.passed_count;
                bySchool[s.school_name].yiduan_rate = s.pass_rate;
                bySchool[s.school_name].yiduan_rank = s.pass_rate_rank != null ? s.pass_rate_rank : '-';
                if (bySchool[s.school_name].ref_count == null) {
                    bySchool[s.school_name].ref_count = s.total_students;
                    bySchool[s.school_name].avg_score = s.average_score;
                    bySchool[s.school_name].avg_rank = s.avg_score_rank != null ? s.avg_score_rank : '-';
                }
            });

            let html = '<hr class="my-4"><h5 class="mb-3">各校对比总表</h5>';
            html += '<div class="table-responsive mb-4 league-comparison-table-wrap"><table class="table table-bordered table-sm league-comparison-table"><thead><tr><th>指标</th>';
            schoolList.forEach(s => { html += '<th>' + s + '</th>'; });
            html += '</tr></thead><tbody>';
            const row = (label, key, fmt) => {
                let r = '<tr><td class="text-nowrap">' + label + '</td>';
                schoolList.forEach(name => {
                    const v = bySchool[name] && bySchool[name][key] != null ? bySchool[name][key] : '-';
                    r += '<td>' + (typeof fmt === 'function' ? fmt(v) : v) + '</td>';
                });
                return r + '</tr>';
            };
            html += row('参考人数', 'ref_count');
            html += row('特控上线人数', 'tekong_passed');
            html += row('特控率', 'tekong_rate', v => (typeof v === 'number' ? v + '%' : v));
            html += row('特控率排名', 'tekong_rank');
            html += row('一段上线人数', 'yiduan_passed');
            html += row('一段上线率', 'yiduan_rate', v => (typeof v === 'number' ? v + '%' : v));
            html += row('一段上线率排名', 'yiduan_rank');
            html += row('平均分', 'avg_score');
            html += row('平均分排名', 'avg_rank');
            html += '</tbody></table></div>';
            var totalTableHtml = html;

            var subjectRankings = (dataTekong && dataTekong.subject_rankings) ? dataTekong.subject_rankings : {};
            var subjectsWithRank = sortSubjects(Object.keys(subjectRankings));
            var avgRankHtml = '';
            if (subjectsWithRank.length > 0) {
                avgRankHtml = '<div class="table-responsive mb-4"><table class="table table-bordered table-sm league-comparison-table"><thead><tr><th>学科</th>';
                schoolList.forEach(function(s) { avgRankHtml += '<th>' + s + '</th>'; });
                avgRankHtml += '</tr></thead><tbody>';
                subjectsWithRank.forEach(function(subj) {
                    var list = subjectRankings[subj] || [];
                    var bySchoolSubj = {};
                    list.forEach(function(x) { bySchoolSubj[x.school_name] = { avg: x.average_score, rank: x.rank }; });
                    avgRankHtml += '<tr><td class="text-nowrap">' + subj + ' 平均分</td>';
                    schoolList.forEach(function(name) {
                        var o = bySchoolSubj[name];
                        avgRankHtml += '<td>' + (o ? o.avg : '-') + '</td>';
                    });
                    avgRankHtml += '</tr><tr><td class="text-nowrap">' + subj + ' 名次</td>';
                    schoolList.forEach(function(name) {
                        var o = bySchoolSubj[name];
                        avgRankHtml += '<td>' + (o ? o.rank : '-') + '</td>';
                    });
                    avgRankHtml += '</tr>';
                });
                avgRankHtml += '</tbody></table></div>';
            }

            function renderSubjectLineTable(lineName, lineData) {
                if (!lineData || Object.keys(lineData).length === 0) return '';
                var allSubjects = sortSubjects(Object.keys(lineData));
                var t = '<div class="table-responsive mb-4"><table class="table table-bordered table-sm league-comparison-table"><thead><tr><th>学科</th>';
                schoolList.forEach(function(s) { t += '<th>' + s + '</th>'; });
                t += '</tr></thead><tbody>';
                allSubjects.forEach(function(subj) {
                    var info = lineData[subj];
                    var stats = (info && info.school_stats) || [];
                    var bySchoolSubj = {};
                    stats.forEach(function(x) { bySchoolSubj[x.school_name] = { passed: x.passed_count, rate: x.pass_rate, rank: x.rank != null ? x.rank : '-' }; });
                    t += '<tr><td class="text-nowrap">' + subj + ' 上线人数</td>';
                    schoolList.forEach(function(name) {
                        var o = bySchoolSubj[name];
                        t += '<td>' + (o ? o.passed : '-') + '</td>';
                    });
                    t += '</tr><tr><td class="text-nowrap">' + subj + ' 上线率</td>';
                    schoolList.forEach(function(name) {
                        var o = bySchoolSubj[name];
                        t += '<td>' + (o ? (typeof o.rate === 'number' ? o.rate + '%' : o.rate) : '-') + '</td>';
                    });
                    t += '</tr><tr><td class="text-nowrap">' + subj + ' 排名</td>';
                    schoolList.forEach(function(name) {
                        var o = bySchoolSubj[name];
                        t += '<td>' + (o ? o.rank : '-') + '</td>';
                    });
                    t += '</tr>';
                });
                t += '</tbody></table></div>';
                return t;
            }
            var tekongLineHtml = subjectLineRankings['特控线'] ? renderSubjectLineTable('特控线', subjectLineRankings['特控线']) : '';
            var yiduanLineHtml = subjectLineRankings['一段线'] ? renderSubjectLineTable('一段线', subjectLineRankings['一段线']) : '';

            var tabs = [];
            if (totalTableHtml) tabs.push({ id: 'total', label: '总表', html: totalTableHtml });
            if (avgRankHtml) tabs.push({ id: 'avg', label: '各学科平均分及排名', html: avgRankHtml });
            if (tekongLineHtml) tabs.push({ id: 'tekong', label: '各学科特控线有效率', html: tekongLineHtml });
            if (yiduanLineHtml) tabs.push({ id: 'yiduan', label: '各学科一段线有效率', html: yiduanLineHtml });
            if (tabs.length === 0) return totalTableHtml || '';
            if (tabs.length === 1) return tabs[0].html;

            var compTs = Date.now();
            var compContentId = 'league_comp_content_' + compTs;
            var out = '<div class="card mb-3 result-section-card"><div class="card-header result-section-header result-section-header-league"><h5 class="mb-0">各校对比表</h5></div><div class="card-body">';
            out += '<p class="text-muted mb-2">选择下方按钮切换查看</p><div class="btn-group flex-wrap mb-3" role="group">';
            tabs.forEach(function(tab, idx) {
                out += '<input type="radio" class="btn-check" name="league_comp_tab_' + compTs + '" id="league_comp_tab_' + compTs + '_' + tab.id + '" value="' + tab.id + '" ' + (idx === 0 ? 'checked' : '') + '><label class="btn btn-outline-primary btn-sm" for="league_comp_tab_' + compTs + '_' + tab.id + '">' + tab.label + '</label>';
            });
            out += '</div><div id="' + compContentId + '">' + tabs[0].html + '</div></div></div>';
            (function(cid, tabList) {
                setTimeout(function() {
                    var el = document.getElementById(cid);
                    if (!el) return;
                    document.querySelectorAll('input[name="league_comp_tab_' + compTs + '"]').forEach(function(radio) {
                        radio.addEventListener('change', function() {
                            var v = radio.value;
                            var tab = tabList.filter(function(t) { return t.id === v; })[0];
                            if (tab && el) el.innerHTML = tab.html;
                        });
                    });
                }, 50);
            })(compContentId, tabs);
            return out;
        }

        // 我校与各校对比区块（联盟数据）：分数线用按钮切换，不堆多个 div
        function createLeagueComparisonSection(leagueAnalysis, tekongLine, yiduanLine) {
            var scoreToName = {};
            if (tekongLine) scoreToName[tekongLine] = '特控线';
            if (yiduanLine) scoreToName[yiduanLine] = '一段线';
            var subjectLineRankings = leagueAnalysis.subject_line_rankings || {};
            var lineKeys = Object.keys(leagueAnalysis).filter(function(k) { return k.startsWith('line_'); });
            var contentByLine = {};
            var firstLineName = null;
            for (var i = 0; i < lineKeys.length; i++) {
                var key = lineKeys[i];
                var data = leagueAnalysis[key];
                if (!data || data.score_line == null) continue;
                var lineName = scoreToName[data.score_line] || ('分数线' + data.score_line + '分');
                if (!firstLineName) firstLineName = lineName;
                var rankTable = '';
                if (data.school_subject_ranks && Object.keys(data.school_subject_ranks).length > 0) {
                    rankTable = '<h6>我校各学科在各校中的排名（按平均分）</h6><div class="table-responsive mb-3"><table class="table table-striped table-sm"><thead><tr><th>学科</th><th>我校排名</th><th>我校平均分</th></tr></thead><tbody>' +
                        sortSubjects(Object.keys(data.school_subject_ranks)).map(function(subj) {
                            var rank = data.school_subject_ranks[subj];
                            var avg = (data.school_subject_averages && data.school_subject_averages[subj] != null) ? data.school_subject_averages[subj] : '-';
                            return '<tr><td>' + subj + '</td><td><strong>第 ' + rank + ' 名</strong></td><td>' + avg + '</td></tr>';
                        }).join('') + '</tbody></table></div>';
                }
                var top10 = (data.school_stats || []).slice(0, 10).map(function(s, i) {
                    return '<tr><td>' + (i+1) + '</td><td>' + s.school_name + '</td><td>' + s.total_students + '</td><td>' + s.passed_count + '</td><td><strong>' + s.pass_rate + '%</strong></td><td>' + (s.average_score != null ? s.average_score : '-') + '</td></tr>';
                }).join('');
                contentByLine[lineName] = '<h6 class="text-primary">' + lineName + ' (' + data.score_line + '分)</h6><div class="row mb-3">' +
                    '<div class="col-md-3"><div class="stat-card"><h3>' + data.league_passed_count + '/' + data.league_total + '</h3><p>联盟过线/总人数</p></div></div>' +
                    '<div class="col-md-3"><div class="stat-card"><h3>' + data.school_passed_count + '/' + data.school_total + '</h3><p>我校过线/总人数</p></div></div>' +
                    '<div class="col-md-3"><div class="stat-card"><h3>' + data.school_pass_rate + '%</h3><p>我校过线率</p></div></div>' +
                    '<div class="col-md-3"><div class="stat-card"><h3>' + (data.school_rank != null ? '第' + data.school_rank + '名' : '-') + '</h3><p>我校在各校中排名</p></div></div></div>' +
                    (data.school_rank != null ? '<p class="alert alert-info mb-2"><strong>我校的线在各校的排名：</strong>第 ' + data.school_rank + ' 名</p>' : '') +
                    rankTable +
                    '<h6>各校过线率排名（前10）</h6><div class="table-responsive mb-3"><table class="table table-striped table-sm"><thead><tr><th>排名</th><th>学校</th><th>总人数</th><th>过线人数</th><th>过线率(%)</th><th>平均分</th></tr></thead><tbody>' + top10 + '</tbody></table></div>';
            }
            var lineNames = Object.keys(contentByLine);
            if (lineNames.length === 0) firstLineName = null; else if (!firstLineName) firstLineName = lineNames[0];
            var ts = Date.now();
            var contentId = 'league_compare_content_' + ts;
            var html = '<div class="card mb-3 result-section-card"><div class="card-header result-section-header result-section-header-league"><h5 class="mb-0">五、我校与各校对比</h5></div><div class="card-body">';
            html += '<p class="text-muted mb-2">选择分数线查看</p><div class="btn-group flex-wrap mb-3" role="group">';
            for (var j = 0; j < lineNames.length; j++) {
                var ln = lineNames[j];
                var isFirst = (ln === firstLineName);
                html += '<input type="radio" class="btn-check" name="league_compare_line_' + ts + '" id="league_line_' + ts + '_' + j + '" value="' + ln + '" ' + (isFirst ? 'checked' : '') + '><label class="btn btn-sm ' + (ln === '特控线' ? 'btn-outline-danger' : 'btn-outline-success') + '" for="league_line_' + ts + '_' + j + '">' + ln + '</label>';
            }
            html += '</div><div id="' + contentId + '"></div>';
            html += '</div></div>';
            if (firstLineName && contentByLine[firstLineName]) {
                (function(cid, byLine, first) {
                    setTimeout(function() {
                        var el = document.getElementById(cid);
                        if (el) el.innerHTML = byLine[first] || '';
                        document.querySelectorAll('input[name="league_compare_line_' + ts + '"]').forEach(function(radio) {
                            radio.addEventListener('change', function() {
                                var e = document.getElementById(cid);
                                if (e && this.value) e.innerHTML = byLine[this.value] || '';
                            });
                        });
                    }, 50);
                })(contentId, contentByLine, firstLineName);
            }
            // 各校对比总表 + 各学科平均分/特控/一段（表格形式，可导出）
            html += createLeagueSchoolComparisonTables(leagueAnalysis, tekongLine, yiduanLine, subjectLineRankings);
            // 学科过线率排名（各校）：仅当用户设置了学科线时展示
            if (Object.keys(subjectLineRankings).length > 0) {
                // 1) 各学科过线率对比图（各校），风格类似“班级各科过线情况”
                html += createLeagueSubjectCharts(subjectLineRankings);

                // 2) 校际各学科过线率汇总表：一个卡片，分数线按钮切换
                var summaryLineNames = Object.keys(subjectLineRankings).filter(function(ln) {
                    var s = subjectLineRankings[ln];
                    return s && Object.keys(s).length > 0;
                });
                if (summaryLineNames.length > 0) {
                    var summaryTs = Date.now();
                    var summaryContentId = 'league_summary_content_' + summaryTs;
                    var summaryByLine = {};
                    summaryLineNames.forEach(function(lineName) {
                        var subjects = subjectLineRankings[lineName];
                        var allSubjects = sortSubjects(Object.keys(subjects));
                        var schoolSet = {};
                        allSubjects.forEach(function(subj) {
                            var info = subjects[subj];
                            (info && info.school_stats || []).forEach(function(s) {
                                if (s && s.school_name != null) schoolSet[String(s.school_name)] = true;
                            });
                        });
                        var schools = Object.keys(schoolSet);
                        if (schools.length === 0) { summaryByLine[lineName] = ''; return; }
                        var thCells = allSubjects.map(function(s) { return '<th>' + s + '过线率(%)</th>'; }).join('');
                        var tbody = schools.map(function(schoolName) {
                            var cells = allSubjects.map(function(subj) {
                                var info = subjects[subj];
                                var stats = (info && info.school_stats) || [];
                                var found = stats.filter(function(x) { return String(x.school_name) === String(schoolName); })[0];
                                return '<td>' + (found ? found.pass_rate : '-') + '</td>';
                            }).join('');
                            return '<tr><td>' + schoolName + '</td>' + cells + '</tr>';
                        }).join('');
                        summaryByLine[lineName] = '<div class="table-responsive"><table class="table table-striped table-sm table-bordered"><thead><tr><th>学校</th>' + thCells + '</tr></thead><tbody>' + tbody + '</tbody></table></div>';
                    });
                    html += '<div class="card mb-3 result-section-card"><div class="card-header result-section-header result-section-header-league"><h5 class="mb-0">校际各学科过线率汇总</h5></div><div class="card-body">';
                    html += '<p class="text-muted mb-2">选择分数线查看</p><div class="btn-group flex-wrap mb-3" role="group">';
                    summaryLineNames.forEach(function(ln, idx) {
                        html += '<input type="radio" class="btn-check" name="league_summary_line_' + summaryTs + '" id="league_summary_' + summaryTs + '_' + idx + '" value="' + ln + '" ' + (idx === 0 ? 'checked' : '') + '><label class="btn btn-sm ' + (ln === '特控线' ? 'btn-outline-danger' : 'btn-outline-success') + '" for="league_summary_' + summaryTs + '_' + idx + '">' + ln + '</label>';
                    });
                    html += '</div><div id="' + summaryContentId + '">' + (summaryByLine[summaryLineNames[0]] || '') + '</div></div></div>';
                    (function(cid, byLine, names) {
                        setTimeout(function() {
                            document.querySelectorAll('input[name="league_summary_line_' + summaryTs + '"]').forEach(function(radio) {
                                radio.addEventListener('change', function() {
                                    var el = document.getElementById(cid);
                                    if (el && this.value) el.innerHTML = byLine[this.value] || '';
                                });
                            });
                        }, 50);
                    })(summaryContentId, summaryByLine, summaryLineNames);
                }
            }
            html += '</div></div>';
            return html;
        }

        // 校际各学科过线率对比图（一个卡片，分数线+学科按钮切换）
        function createLeagueSubjectCharts(subjectLineRankings) {
            var lineNames = Object.keys(subjectLineRankings || {}).filter(function(ln) {
                var s = subjectLineRankings[ln];
                return s && Object.keys(s).length > 0;
            });
            if (lineNames.length === 0) return '';
            var ts = Date.now();
            var chartId = 'league_subj_chart_u_' + ts;
            var tableId = 'league_subj_table_u_' + ts;
            var firstLine = lineNames[0];
            var subjListByLine = {};
            lineNames.forEach(function(ln) {
                subjListByLine[ln] = sortSubjects(Object.keys(subjectLineRankings[ln]));
            });
            var firstSubj = subjListByLine[firstLine] && subjListByLine[firstLine][0];

            var html = '<div class="card mb-3 result-section-card"><div class="card-header result-section-header result-section-header-league"><h5 class="mb-0">各学科过线率对比图（各校）</h5></div><div class="card-body">';
            html += '<p class="text-muted mb-2">先选分数线，再选学科</p><div class="btn-group flex-wrap mb-2" role="group">';
            lineNames.forEach(function(ln, idx) {
                html += '<input type="radio" class="btn-check" name="league_subj_line_' + ts + '" id="league_subj_line_' + ts + '_' + idx + '" value="' + ln + '" ' + (ln === firstLine ? 'checked' : '') + '><label class="btn btn-sm ' + (ln === '特控线' ? 'btn-outline-danger' : 'btn-outline-success') + '" for="league_subj_line_' + ts + '_' + idx + '">' + ln + '</label>';
            });
            html += '</div><div class="btn-group flex-wrap mb-3" id="league_subj_subj_wrap_' + ts + '" role="group"></div>';
            html += '<div class="chart-container" id="' + chartId + '" style="height:380px;"></div><div id="' + tableId + '" class="table-responsive mt-3"></div></div></div>';

            window._leagueSubjectsUnified = window._leagueSubjectsUnified || {};
            window._leagueSubjectsUnified[ts] = { subjectLineRankings: subjectLineRankings, chartId: chartId, tableId: tableId, subjListByLine: subjListByLine, lineNames: lineNames };

            function fillLeagueSubjButtons(uid) {
                var u = window._leagueSubjectsUnified[uid];
                if (!u) return;
                var lineRadio = document.querySelector('input[name="league_subj_line_' + uid + '"]:checked');
                var lineName = lineRadio ? lineRadio.value : u.lineNames[0];
                var subjList = u.subjListByLine[lineName] || [];
                var wrap = document.getElementById('league_subj_subj_wrap_' + uid);
                if (!wrap) return;
                wrap.innerHTML = subjList.map(function(s, i) {
                    return '<input type="radio" class="btn-check" name="league_subj_subj_' + uid + '" id="league_subj_subj_' + uid + '_' + s + '" value="' + s + '" ' + (i === 0 ? 'checked' : '') + '><label class="btn btn-outline-primary btn-sm" for="league_subj_subj_' + uid + '_' + s + '">' + s + '</label>';
                }).join('');
                wrap.querySelectorAll('input').forEach(function(radio) {
                    radio.addEventListener('change', function() { if (this.checked) renderLeagueSubjectViewUnified(uid); });
                });
            }

            function renderLeagueSubjectViewUnified(uid) {
                var u = window._leagueSubjectsUnified[uid];
                if (!u) return;
                var lineRadio = document.querySelector('input[name="league_subj_line_' + uid + '"]:checked');
                var lineName = lineRadio ? lineRadio.value : u.lineNames[0];
                var subjRadio = document.querySelector('input[name="league_subj_subj_' + uid + '"]:checked');
                var subjects = u.subjectLineRankings[lineName];
                var subject = subjRadio ? subjRadio.value : (u.subjListByLine[lineName] && u.subjListByLine[lineName][0]);
                if (!subjects || !subject || !subjects[subject]) return;
                var info = subjects[subject];
                var stats = (info.school_stats || []).slice().sort(function(a, b) { return (b.pass_rate || 0) - (a.pass_rate || 0); });
                var schools = stats.map(function(s) { return s.school_name; });
                var passRates = stats.map(function(s) { return s.pass_rate; });
                var totals = stats.map(function(s) { return s.total_students; });
                var container = document.getElementById(u.chartId);
                var tableContainer = document.getElementById(u.tableId);
                if (container) {
                    var existingChart = echarts.getInstanceByDom(container);
                    if (existingChart) existingChart.dispose();
                    var chart = echarts.init(container);
                    chart.setOption({
                        title: { text: lineName + ' - ' + subject + ' 各校过线率', left: 'center' },
                        tooltip: { trigger: 'axis', formatter: function(params) { var i = params[0].dataIndex; return schools[i] + '<br/>过线率: ' + passRates[i] + '%<br/>总人数: ' + totals[i]; } },
                        xAxis: { type: 'category', name: '学校', data: schools, axisLabel: { rotate: 45, interval: 0 } },
                        yAxis: { type: 'value', name: '过线率(%)', max: 100 },
                        series: [{ name: '过线率(%)', type: 'bar', data: passRates, itemStyle: { color: function(p) { return p.dataIndex < 3 ? '#ff6b6b' : '#4ecdc4'; } } }]
                    });
                    setTimeout(function() { chart.resize(); }, 80);
                }
                if (tableContainer) {
                    var rows = stats.map(function(s, i) {
                        return '<tr><td>' + (i + 1) + '</td><td>' + s.school_name + '</td><td>' + s.total_students + '</td><td>' + s.passed_count + '</td><td><strong>' + s.pass_rate + '%</strong></td></tr>';
                    }).join('');
                    tableContainer.innerHTML = '<table class="table table-striped table-bordered table-sm mb-0"><thead><tr><th>排名</th><th>学校</th><th>总人数</th><th>过线人数</th><th>过线率(%)</th></tr></thead><tbody>' + rows + '</tbody></table>';
                }
            }

            setTimeout(function() {
                fillLeagueSubjButtons(ts);
                renderLeagueSubjectViewUnified(ts);
                document.querySelectorAll('input[name="league_subj_line_' + ts + '"]').forEach(function(radio) {
                    radio.addEventListener('change', function() { fillLeagueSubjButtons(ts); renderLeagueSubjectViewUnified(ts); });
                });
            }, 100);
            return html;
        }

        // 渲染某一学科在各校的过线率柱状图 + 表格
        function renderLeagueSubjectView(chartId, subject) {
            const stored = window._leagueSubjectsData && window._leagueSubjectsData[chartId];
            if (!stored) return;
            const { lineName, subjects } = stored;
            const info = subjects[subject];
            if (!info || !info.school_stats) return;

            const stats = (info.school_stats || []).slice().sort((a, b) => (b.pass_rate || 0) - (a.pass_rate || 0));
            const schools = stats.map(s => s.school_name);
            const passRates = stats.map(s => s.pass_rate);
            const totals = stats.map(s => s.total_students);

            const container = document.getElementById(chartId);
            const tableContainer = document.getElementById(chartId + '_table');
            if (!container) return;

            const existingChart = echarts.getInstanceByDom(container);
            if (existingChart) existingChart.dispose();

            const chart = echarts.init(container);
            chart.setOption({
                title: { text: `${lineName} - ${subject} 各校过线率`, left: 'center' },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const i = params[0].dataIndex;
                        return schools[i] + '<br/>过线率: ' + passRates[i] + '%<br/>总人数: ' + totals[i];
                    }
                },
                xAxis: {
                    type: 'category',
                    name: '学校',
                    data: schools,
                    axisLabel: { rotate: 45, interval: 0 }
                },
                yAxis: { type: 'value', name: '过线率(%)', max: 100 },
                series: [{
                    name: '过线率(%)',
                    type: 'bar',
                    data: passRates,
                    itemStyle: {
                        color: function(p) { return p.dataIndex < 3 ? '#ff6b6b' : '#4ecdc4'; }
                    }
                }]
            });
            setTimeout(() => chart.resize(), 80);

            if (tableContainer) {
                var rows = stats.map(function(s, i) {
                    return '<tr><td>' + (i+1) + '</td><td>' + s.school_name + '</td><td>' + s.total_students + '</td><td>' + s.passed_count + '</td><td><strong>' + s.pass_rate + '%</strong></td></tr>';
                }).join('');
                tableContainer.innerHTML = '<table class="table table-striped table-bordered table-sm mb-0">' +
                    '<thead><tr><th>排名</th><th>学校</th><th>总人数</th><th>过线人数</th><th>过线率(%)</th></tr></thead>' +
                    '<tbody>' + rows + '</tbody></table>';
            }
        }
        
        // 班级各科过线情况（特控线+一段线合并为一张卡，分数线+学科用按钮切换）
        function createUnifiedClassSubjectsSection(tekongData, yiduanData, tekongLine, yiduanLine) {
            var ts = Date.now();
            var chartId = 'class_subj_chart_u_' + ts;
            var tableId = 'class_subj_table_u_' + ts;
            var accordionId = 'class_subj_accordion_u_' + ts;
            var lineTekong = (tekongData && tekongData.classes && Object.keys(tekongData.classes).length > 0);
            var lineYiduan = (yiduanData && yiduanData.classes && Object.keys(yiduanData.classes).length > 0);
            var firstLine = lineTekong ? '特控线' : '一段线';
            var allSubjectsT = lineTekong ? sortSubjects(Object.keys(tekongData.subject_lines || {})) : [];
            var allSubjectsY = lineYiduan ? sortSubjects(Object.keys(yiduanData.subject_lines || {})) : [];
            var firstSubj = (firstLine === '特控线' ? allSubjectsT[0] : allSubjectsY[0]) || '';
            var allClassesT = lineTekong ? Object.keys(tekongData.classes).sort(function(a,b){ return (isNaN(Number(a))||isNaN(Number(b))) ? String(a).localeCompare(b) : Number(a)-Number(b); }) : [];
            var allClassesY = lineYiduan ? Object.keys(yiduanData.classes).sort(function(a,b){ return (isNaN(Number(a))||isNaN(Number(b))) ? String(a).localeCompare(b) : Number(a)-Number(b); }) : [];

            var html = '<div class="card mb-3 result-section-card">';
            html += '<div class="card-header result-section-header result-section-header-info"><h5 class="mb-0">二、班级各科过线情况</h5></div>';
            html += '<div class="card-body">';
            html += '<p class="text-muted mb-2">先选分数线，再选学科；表中同时显示过线人数与过线率</p>';
            html += '<div class="btn-group flex-wrap mb-2" role="group">';
            if (lineTekong) html += '<input type="radio" class="btn-check" name="class_subj_line_u_' + ts + '" id="class_subj_line_tekong_' + ts + '" value="特控线" ' + (firstLine === '特控线' ? 'checked' : '') + '><label class="btn btn-outline-danger btn-sm" for="class_subj_line_tekong_' + ts + '">特控线</label>';
            if (lineYiduan) html += '<input type="radio" class="btn-check" name="class_subj_line_u_' + ts + '" id="class_subj_line_yiduan_' + ts + '" value="一段线" ' + (firstLine === '一段线' ? 'checked' : '') + '><label class="btn btn-outline-success btn-sm" for="class_subj_line_yiduan_' + ts + '">一段线</label>';
            html += '</div>';
            html += '<div class="btn-group flex-wrap mb-3" id="class_subj_subj_wrap_u_' + ts + '" role="group"></div>';
            html += '<div class="chart-container mb-3" id="' + chartId + '" style="height:400px;"></div>';
            html += '<div id="' + tableId + '" class="table-responsive mb-3"></div>';
            html += '<div class="accordion mb-0" id="' + accordionId + '"><div class="accordion-item"><h2 class="accordion-header">';
            html += '<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#class_subj_full_' + ts + '" aria-expanded="false">查看全部学科汇总表</button></h2>';
            html += '<div id="class_subj_full_' + ts + '" class="accordion-collapse collapse" data-bs-parent="#' + accordionId + '"><div class="accordion-body p-0"><div class="table-responsive" id="class_subj_full_table_wrap_' + ts + '"></div></div></div></div></div>';
            html += '</div></div>';

            window._classSubjectsUnified = window._classSubjectsUnified || {};
            window._classSubjectsUnified[ts] = {
                tekong: tekongData,
                yiduan: yiduanData,
                chartId: chartId,
                tableId: tableId,
                accordionId: accordionId,
                allSubjectsT: allSubjectsT,
                allSubjectsY: allSubjectsY,
                allClassesT: allClassesT,
                allClassesY: allClassesY
            };

            function renderUnifiedClassSubject(uid) {
                var u = window._classSubjectsUnified[uid];
                if (!u) return;
                var lineName = document.querySelector('input[name="class_subj_line_u_' + uid + '"]:checked');
                lineName = lineName ? lineName.value : '特控线';
                var data = lineName === '特控线' ? u.tekong : u.yiduan;
                var allSubjects = lineName === '特控线' ? u.allSubjectsT : u.allSubjectsY;
                var allClasses = lineName === '特控线' ? u.allClassesT : u.allClassesY;
                var subjRadio = document.querySelector('input[name="class_subj_subj_u_' + uid + '"]:checked');
                var subject = subjRadio ? subjRadio.value : (allSubjects[0] || '');
                if (!data || !allClasses.length || !allSubjects.length) return;
                var passedCounts = allClasses.map(function(c){ return (data.classes[c] && data.classes[c][subject]) ? data.classes[c][subject].passed_count : 0; });
                var passRates = allClasses.map(function(c){ return (data.classes[c] && data.classes[c][subject]) ? data.classes[c][subject].pass_rate : 0; });
                var container = document.getElementById(u.chartId);
                var tableContainer = document.getElementById(u.tableId);
                if (container) {
                    var existingChart = echarts.getInstanceByDom(container);
                    if (existingChart) existingChart.dispose();
                    var chart = echarts.init(container);
                    chart.setOption({
                        title: { text: lineName + ' - ' + subject + ' 各班过线情况', left: 'center' },
                        tooltip: { trigger: 'axis', formatter: function(params){ var i=params[0].dataIndex; return allClasses[i]+'班<br/>过线人数: '+passedCounts[i]+'<br/>过线率: '+passRates[i]+'%'; } },
                        legend: { data: [subject+'过线人数', subject+'过线率'], bottom: 8 },
                        xAxis: { type: 'category', name: '班级', data: allClasses, axisLabel: { rotate: 45 } },
                        yAxis: [ { type: 'value', name: '过线人数', position: 'left' }, { type: 'value', name: '过线率(%)', position: 'right', max: 100 } ],
                        series: [
                            { name: subject+'过线人数', type: 'bar', data: passedCounts, yAxisIndex: 0, itemStyle: { color: '#4ecdc4' } },
                            { name: subject+'过线率', type: 'line', data: passRates, yAxisIndex: 1, itemStyle: { color: '#ff6b6b' }, lineStyle: { width: 2 } }
                        ]
                    });
                    setTimeout(function(){ chart.resize(); }, 50);
                }
                if (tableContainer) {
                    var rows = allClasses.map(function(c, i){ return '<tr><td><strong>'+c+'</strong></td><td>'+passedCounts[i]+'</td><td>'+passRates[i]+'%</td></tr>'; }).join('');
                    tableContainer.innerHTML = '<table class="table table-striped table-bordered table-sm"><thead><tr><th>班级</th><th>过线人数</th><th>过线率(%)</th></tr></thead><tbody>'+rows+'</tbody></table>';
                }
                var fullWrap = document.getElementById('class_subj_full_table_wrap_' + uid);
                if (fullWrap && data.classes) {
                    var thSubj = allSubjects.map(function(s){ return '<th colspan="2">'+s+'</th>'; }).join('');
                    var thRate = allSubjects.map(function(){ return '<th>过线人数</th><th>过线率(%)</th>'; }).join('');
                    var tbody = allClasses.map(function(class_name){
                        var cells = allSubjects.map(function(subj){
                            var info = data.classes[class_name] && data.classes[class_name][subj];
                            return '<td>'+(info ? info.passed_count : '-')+'</td><td>'+(info ? info.pass_rate.toFixed(2) : '-')+'</td>';
                        }).join('');
                        return '<tr><td><strong>'+class_name+'</strong></td>'+cells+'</tr>';
                    }).join('');
                    fullWrap.innerHTML = '<table class="table table-striped table-bordered table-sm mb-0"><thead><tr><th rowspan="2">班级</th>'+thSubj+'</tr><tr>'+thRate+'</tr></thead><tbody>'+tbody+'</tbody></table>';
                }
            }

            function fillSubjectButtons(uid) {
                var u = window._classSubjectsUnified[uid];
                if (!u) return;
                var lineName = document.querySelector('input[name="class_subj_line_u_' + uid + '"]:checked');
                lineName = lineName ? lineName.value : '特控线';
                var allSubjects = lineName === '特控线' ? u.allSubjectsT : u.allSubjectsY;
                var wrap = document.getElementById('class_subj_subj_wrap_u_' + uid);
                if (!wrap) return;
                wrap.innerHTML = allSubjects.map(function(s, i){
                    return '<input type="radio" class="btn-check" name="class_subj_subj_u_' + uid + '" id="class_subj_subj_' + uid + '_' + s + '" value="'+s+'" ' + (i === 0 ? 'checked' : '') + '><label class="btn btn-outline-primary btn-sm" for="class_subj_subj_' + uid + '_' + s + '">'+s+'</label>';
                }).join('');
                wrap.querySelectorAll('input').forEach(function(radio){
                    radio.addEventListener('change', function(){ if (this.checked) renderUnifiedClassSubject(uid); });
                });
            }

            setTimeout(function(){
                fillSubjectButtons(ts);
                renderUnifiedClassSubject(ts);
                document.querySelectorAll('input[name="class_subj_line_u_' + ts + '"]').forEach(function(radio){
                    radio.addEventListener('change', function(){
                        fillSubjectButtons(ts);
                        renderUnifiedClassSubject(ts);
                    });
                });
            }, 100);
            return html;
        }

        // 学科分数线详情（特控线+一段线合并为一张卡，分数线+学科用按钮切换）
        function createUnifiedSubjectLinesSection(tekongData, yiduanData) {
            var ts = Date.now();
            var tableWrapId = 'subject_lines_table_u_' + ts;
            var chartId = 'subject_lines_chart_u_' + ts;
            var hasT = tekongData && tekongData.subjects && Object.keys(tekongData.subjects).length > 0;
            var hasY = yiduanData && yiduanData.subjects && Object.keys(yiduanData.subjects).length > 0;
            var firstLine = hasT ? '特控线' : '一段线';
            var subjListT = hasT ? sortSubjects(Object.keys(tekongData.subjects)) : [];
            var subjListY = hasY ? sortSubjects(Object.keys(yiduanData.subjects)) : [];
            var firstSubj = (firstLine === '特控线' ? subjListT[0] : subjListY[0]) || '';

            var html = '<div class="card mb-3 result-section-card">';
            html += '<div class="card-header result-section-header result-section-header-warning"><h5 class="mb-0">三、各学科分数线详情</h5></div>';
            html += '<div class="card-body">';
            html += '<p class="text-muted mb-2">先选分数线，再选学科</p>';
            html += '<div class="btn-group flex-wrap mb-2" role="group">';
            if (hasT) html += '<input type="radio" class="btn-check" name="subject_lines_line_u_' + ts + '" id="sl_line_tekong_' + ts + '" value="特控线" ' + (firstLine === '特控线' ? 'checked' : '') + '><label class="btn btn-outline-danger btn-sm" for="sl_line_tekong_' + ts + '">特控线</label>';
            if (hasY) html += '<input type="radio" class="btn-check" name="subject_lines_line_u_' + ts + '" id="sl_line_yiduan_' + ts + '" value="一段线" ' + (firstLine === '一段线' ? 'checked' : '') + '><label class="btn btn-outline-success btn-sm" for="sl_line_yiduan_' + ts + '">一段线</label>';
            html += '</div>';
            html += '<div class="btn-group flex-wrap mb-3" id="subject_lines_subj_wrap_u_' + ts + '" role="group"></div>';
            html += '<div id="' + tableWrapId + '" class="table-responsive mb-3"></div>';
            html += '<div class="chart-container" id="' + chartId + '" style="height:400px;"></div>';
            html += '</div></div>';

            window._subjectLinesUnified = window._subjectLinesUnified || {};
            window._subjectLinesUnified[ts] = { tekong: tekongData, yiduan: yiduanData, tableWrapId: tableWrapId, chartId: chartId, subjListT: subjListT, subjListY: subjListY };

            function renderUnifiedSubjectLine(uid) {
                var u = window._subjectLinesUnified[uid];
                if (!u) return;
                var lineRadio = document.querySelector('input[name="subject_lines_line_u_' + uid + '"]:checked');
                var lineName = lineRadio ? lineRadio.value : '特控线';
                var data = lineName === '特控线' ? u.tekong : u.yiduan;
                var subjRadio = document.querySelector('input[name="subject_lines_subj_u_' + uid + '"]:checked');
                var subjList = lineName === '特控线' ? u.subjListT : u.subjListY;
                var subject = subjRadio ? subjRadio.value : (subjList[0] || '');
                if (!data || !data.subjects || !data.subjects[subject]) return;
                var subjectData = data.subjects[subject];
                var tableWrap = document.getElementById(u.tableWrapId);
                var container = document.getElementById(u.chartId);
                if (tableWrap) {
                    var rows = (subjectData.class_stats || []).map(function(stat){
                        return '<tr><td>'+stat.class_name+'</td><td>'+stat.total_students+'</td><td>'+stat.passed_count+'</td><td>'+stat.pass_rate+'</td></tr>';
                    }).join('');
                    tableWrap.innerHTML = '<table class="table table-striped table-bordered table-sm"><thead><tr><th>班级</th><th>总人数</th><th>过线人数</th><th>过线率(%)</th></tr></thead><tbody>'+rows+'</tbody></table>';
                }
                if (container) {
                    var existingChart = echarts.getInstanceByDom(container);
                    if (existingChart) existingChart.dispose();
                    createSubjectLineChart(u.chartId, subject, subjectData, lineName);
                }
            }

            function fillSubjectLineButtons(uid) {
                var u = window._subjectLinesUnified[uid];
                if (!u) return;
                var lineRadio = document.querySelector('input[name="subject_lines_line_u_' + uid + '"]:checked');
                var lineName = lineRadio ? lineRadio.value : '特控线';
                var subjList = lineName === '特控线' ? u.subjListT : u.subjListY;
                var wrap = document.getElementById('subject_lines_subj_wrap_u_' + uid);
                if (!wrap) return;
                wrap.innerHTML = subjList.map(function(s, i){
                    return '<input type="radio" class="btn-check" name="subject_lines_subj_u_' + uid + '" id="sl_subj_' + uid + '_' + s + '" value="'+s+'" ' + (i === 0 ? 'checked' : '') + '><label class="btn btn-outline-primary btn-sm" for="sl_subj_' + uid + '_' + s + '">'+s+'</label>';
                }).join('');
                wrap.querySelectorAll('input').forEach(function(radio){
                    radio.addEventListener('change', function(){ if (this.checked) renderUnifiedSubjectLine(uid); });
                });
            }

            setTimeout(function(){
                fillSubjectLineButtons(ts);
                renderUnifiedSubjectLine(ts);
                document.querySelectorAll('input[name="subject_lines_line_u_' + ts + '"]').forEach(function(radio){
                    radio.addEventListener('change', function(){
                        fillSubjectLineButtons(ts);
                        renderUnifiedSubjectLine(ts);
                    });
                });
            }, 150);
            return html;
        }

        // 创建班级各科情况：按学科分开展示，用选项卡切换（保留供单线调用，现主用 createUnifiedClassSubjectsSection）
        function createClassSubjectsTable(data, lineName, scoreLine) {
            const allClasses = Object.keys(data.classes).sort((a, b) => (isNaN(Number(a)) || isNaN(Number(b))) ? String(a).localeCompare(b) : Number(a) - Number(b));
            const allSubjects = sortSubjects(Object.keys(data.subject_lines || {}));
            
            if (allClasses.length === 0 || allSubjects.length === 0) {
                return '';
            }
            
            const chartId = `class_subjects_chart_${lineName}_${Date.now()}`;
            const tableContainerId = `${chartId}_table`;
            const firstSubject = allSubjects[0];
            
            let tableHtml = `
                <div class="card mb-3 result-section-card">
                    <div class="card-header result-section-header result-section-header-info">
                        <h5 class="mb-0">二、${lineName} - 班级各科过线情况</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-2">按学科查看，点击学科按钮切换</p>
                        <div class="btn-group flex-wrap mb-3 class-subject-tabs" role="group" data-chart-id="${chartId}" data-table-id="${tableContainerId}">
                            ${allSubjects.map(s => `
                                <input type="radio" class="btn-check" name="${chartId}_subj" id="${chartId}_btn_${s}" value="${s}" ${s === firstSubject ? 'checked' : ''}>
                                <label class="btn btn-outline-primary btn-sm class-subject-tab" for="${chartId}_btn_${s}">${s}</label>
                            `).join('')}
                        </div>
                        <div class="class-subject-chart-wrap mb-3">
                            <div class="chart-container" id="${chartId}" style="height: 400px;"></div>
                        </div>
                        <div id="${tableContainerId}" class="table-responsive mb-3">
                            <!-- 当前学科的表格由 JS 填充 -->
                        </div>
                        <div class="accordion mb-0" id="${chartId}_accordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${chartId}_full_table" aria-expanded="false">查看全部学科汇总表</button>
                                </h2>
                                <div id="${chartId}_full_table" class="accordion-collapse collapse" data-bs-parent="#${chartId}_accordion">
                                    <div class="accordion-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-bordered table-sm mb-0">
                                                <thead>
                                                    <tr>
                                                        <th rowspan="2">班级</th>
                                                        ${allSubjects.map(s => `<th colspan="2">${s}</th>`).join('')}
                                                    </tr>
                                                    <tr>
                                                        ${allSubjects.map(() => '<th>过线人数</th><th>过线率(%)</th>').join('')}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${allClasses.map(class_name => `
                                                        <tr>
                                                            <td><strong>${class_name}</strong></td>
                                                            ${allSubjects.map(subject => {
                                                                const info = data.classes[class_name]?.[subject];
                                                                return `
                                                                    <td>${info ? info.passed_count : '-'}</td>
                                                                    <td>${info ? info.pass_rate.toFixed(2) : '-'}</td>
                                                                `;
                                                            }).join('')}
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            window._classSubjectsData = window._classSubjectsData || {};
            window._classSubjectsData[chartId] = { data, lineName, allClasses, allSubjects };
            
            setTimeout(() => {
                renderClassSubjectView(chartId, firstSubject);
                document.querySelectorAll(`input[name="${chartId}_subj"]`).forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.checked) renderClassSubjectView(chartId, this.value);
                    });
                });
            }, 100);
            
            return tableHtml;
        }
        
        // 渲染某一学科的图表和表格
        function renderClassSubjectView(chartId, subject) {
            const stored = window._classSubjectsData && window._classSubjectsData[chartId];
            if (!stored) return;
            const { data, lineName, allClasses, allSubjects } = stored;
            if (!allSubjects.includes(subject)) return;
            
            const container = document.getElementById(chartId);
            const tableContainer = document.getElementById(chartId + '_table');
            if (!container) return;
            
            const existingChart = echarts.getInstanceByDom(container);
            if (existingChart) existingChart.dispose();
            
            const passedCounts = allClasses.map(c => (data.classes[c]?.[subject] || {}).passed_count || 0);
            const passRates = allClasses.map(c => (data.classes[c]?.[subject] || {}).pass_rate || 0);
            
            const chart = echarts.init(container);
            chart.setOption({
                title: { text: `${lineName} - ${subject} 各班过线情况`, left: 'center' },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const i = params[0].dataIndex;
                        return allClasses[i] + '班<br/>过线人数: ' + passedCounts[i] + '<br/>过线率: ' + passRates[i] + '%';
                    }
                },
                legend: { data: [subject + '过线人数', subject + '过线率'], bottom: 8 },
                xAxis: { type: 'category', name: '班级', data: allClasses, axisLabel: { rotate: 45 } },
                yAxis: [
                    { type: 'value', name: '过线人数', position: 'left' },
                    { type: 'value', name: '过线率(%)', position: 'right', max: 100 }
                ],
                series: [
                    { name: subject + '过线人数', type: 'bar', data: passedCounts, yAxisIndex: 0, itemStyle: { color: '#4ecdc4' } },
                    { name: subject + '过线率', type: 'line', data: passRates, yAxisIndex: 1, itemStyle: { color: '#ff6b6b' }, lineStyle: { width: 2 } }
                ]
            });
            setTimeout(() => chart.resize(), 50);
            
            if (tableContainer) {
                tableContainer.innerHTML = `
                    <table class="table table-striped table-bordered table-sm">
                        <thead><tr><th>班级</th><th>过线人数</th><th>过线率(%)</th></tr></thead>
                        <tbody>
                            ${allClasses.map((c, i) => `<tr><td><strong>${c}</strong></td><td>${passedCounts[i]}</td><td>${passRates[i]}%</td></tr>`).join('')}
                        </tbody>
                    </table>
                `;
            }
        }
        
        // 创建学科分数线详情（学科按语数英物化生政史地顺序）
        function createSubjectLinesDetails(data, lineName) {
            const chartId = `subject_lines_chart_${lineName}_${Date.now()}`;
            let html = `
                <div class="card mb-3 result-section-card">
                    <div class="card-header result-section-header result-section-header-warning">
                        <h5 class="mb-0">三、${lineName} - 各学科分数线详情</h5>
                    </div>
                    <div class="card-body">
            `;
            
            for (const subject of sortSubjects(Object.keys(data.subjects || {}))) {
                const subjectData = data.subjects[subject];
                const subjectChartId = `subject_line_chart_${lineName}_${subject}_${Date.now()}`;
                html += `
                    <div class="mb-4">
                        <h6>${subject} (分数线: ${subjectData.score_line}分)</h6>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>班级</th>
                                        <th>总人数</th>
                                        <th>过线人数</th>
                                        <th>过线率(%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${subjectData.class_stats.map(stat => `
                                        <tr>
                                            <td>${stat.class_name}</td>
                                            <td>${stat.total_students}</td>
                                            <td>${stat.passed_count}</td>
                                            <td>${stat.pass_rate}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="chart-container mt-3" id="${subjectChartId}" style="height: 400px;"></div>
                    </div>
                `;
                
                // 渲染学科图表
                setTimeout(() => {
                    createSubjectLineChart(subjectChartId, subject, subjectData, lineName);
                }, 150);
            }
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // 创建总分分析（一个卡片，特控线/一段线按钮切换）
        function createTotalScoreAnalysis(data, tekongLine, yiduanLine) {
            var ts = Date.now();
            var chartId = 'total_score_chart_u_' + ts;
            var statRowId = 'total_score_stat_u_' + ts;
            var tableWrapId = 'total_score_table_u_' + ts;
            var lineDataByKey = {};
            if (data) {
                for (var k in data) {
                    var ld = data[k];
                    if (ld && ld.score_line != null)
                        lineDataByKey[ld.score_line === tekongLine ? '特控线' : '一段线'] = ld;
                }
            }
            var hasT = lineDataByKey['特控线'] && lineDataByKey['特控线'].total_students != null;
            var hasY = lineDataByKey['一段线'] && lineDataByKey['一段线'].total_students != null;
            var firstLine = hasT ? '特控线' : '一段线';

            var html = '<div class="card mb-3 result-section-card">';
            html += '<div class="card-header result-section-header result-section-header-secondary"><h5 class="mb-0">四、总分分析</h5></div>';
            html += '<div class="card-body">';
            html += '<p class="text-muted mb-2">选择分数线查看</p>';
            html += '<div class="btn-group flex-wrap mb-3" role="group">';
            if (hasT) html += '<input type="radio" class="btn-check" name="total_score_line_u_' + ts + '" id="ts_line_tekong_' + ts + '" value="特控线" ' + (firstLine === '特控线' ? 'checked' : '') + '><label class="btn btn-outline-danger btn-sm" for="ts_line_tekong_' + ts + '">特控线</label>';
            if (hasY) html += '<input type="radio" class="btn-check" name="total_score_line_u_' + ts + '" id="ts_line_yiduan_' + ts + '" value="一段线" ' + (firstLine === '一段线' ? 'checked' : '') + '><label class="btn btn-outline-success btn-sm" for="ts_line_yiduan_' + ts + '">一段线</label>';
            html += '</div>';
            html += '<div id="' + statRowId + '" class="row mb-3"></div>';
            html += '<div id="' + tableWrapId + '" class="table-responsive mb-3"></div>';
            html += '<div class="chart-container" id="' + chartId + '" style="height:500px;"></div>';
            html += '</div></div>';

            window._totalScoreUnified = window._totalScoreUnified || {};
            window._totalScoreUnified[ts] = { lineDataByKey: lineDataByKey, chartId: chartId, statRowId: statRowId, tableWrapId: tableWrapId };

            function renderTotalScoreLine(uid) {
                var u = window._totalScoreUnified[uid];
                if (!u) return;
                var lineRadio = document.querySelector('input[name="total_score_line_u_' + uid + '"]:checked');
                var lineName = lineRadio ? lineRadio.value : '特控线';
                var lineData = u.lineDataByKey[lineName];
                if (!lineData) return;
                var statRow = document.getElementById(u.statRowId);
                var tableWrap = document.getElementById(u.tableWrapId);
                var container = document.getElementById(u.chartId);
                if (statRow) {
                    statRow.innerHTML = '<div class="col-md-3"><div class="stat-card"><h3>' + lineData.passed_count + '/' + lineData.total_students + '</h3><p>过线人数/总人数</p></div></div>' +
                        '<div class="col-md-3"><div class="stat-card"><h3>' + lineData.pass_rate + '%</h3><p>过线率</p></div></div>' +
                        '<div class="col-md-3"><div class="stat-card"><h3>' + (lineData.average_score != null ? lineData.average_score : '-') + '</h3><p>平均分</p></div></div>' +
                        '<div class="col-md-3"><div class="stat-card"><h3>' + (lineData.passed_avg_score != null ? lineData.passed_avg_score : '-') + '</h3><p>过线学生平均分</p></div></div>';
                }
                if (tableWrap && lineData.class_stats && lineData.class_stats.length > 0) {
                    var rows = lineData.class_stats.map(function(stat) {
                        return '<tr><td>' + stat.class_name + '</td><td>' + stat.total_students + '</td><td>' + stat.passed_count + '</td><td>' + stat.pass_rate + '</td><td>' + (stat.average_score != null ? stat.average_score : '-') + '</td></tr>';
                    }).join('');
                    tableWrap.innerHTML = '<table class="table table-striped table-sm"><thead><tr><th>班级</th><th>总人数</th><th>过线人数</th><th>过线率(%)</th><th>平均分</th></tr></thead><tbody>' + rows + '</tbody></table>';
                } else if (tableWrap) tableWrap.innerHTML = '';
                if (container && lineData.class_stats && lineData.class_stats.length > 0) {
                    var existingChart = echarts.getInstanceByDom(container);
                    if (existingChart) existingChart.dispose();
                    createTotalScoreChart(u.chartId, lineData, lineName);
                }
            }

            setTimeout(function() {
                renderTotalScoreLine(ts);
                document.querySelectorAll('input[name="total_score_line_u_' + ts + '"]').forEach(function(radio) {
                    radio.addEventListener('change', function() { if (this.checked) renderTotalScoreLine(ts); });
                });
            }, 150);
            return html;
        }
        
        // 创建班级考核结果图表
        function createClassAssessmentChart(chartId, classAssessment) {
            const container = document.getElementById(chartId);
            if (!container) {
                console.error(`图表容器 ${chartId} 不存在`);
                return;
            }
            
            const existingChart = echarts.getInstanceByDom(container);
            if (existingChart) {
                existingChart.dispose();
            }
            
            const classNames = classAssessment.map(item => item.class_name);
            const assessmentScores = classAssessment.map(item => item.assessment_score);
            const tekongRates = classAssessment.map(item => item.tekong_rate);
            const yiduanRates = classAssessment.map(item => item.yiduan_rate);
            
            const chart = echarts.init(container);
            const option = {
                title: {
                    text: '班级考核结果对比',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                legend: {
                    data: ['考核分', '特控率(%)', '一段率(%)'],
                    bottom: 10
                },
                xAxis: {
                    type: 'category',
                    data: classNames,
                    axisLabel: { rotate: 45 }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '考核分',
                        position: 'left',
                        min: 0,
                        max: 1
                    },
                    {
                        type: 'value',
                        name: '过线率(%)',
                        position: 'right',
                        max: 100
                    }
                ],
                series: [
                    {
                        name: '考核分',
                        type: 'bar',
                        data: assessmentScores,
                        itemStyle: {
                            color: function(params) {
                                const score = Number(params.value);
                                if (score >= 0.8) return '#ff6b6b';
                                if (score >= 0.6) return '#4ecdc4';
                                if (score >= 0.4) return '#95e1d3';
                                return '#95a5a6';
                            }
                        },
                        label: {
                            show: true,
                            position: 'top',
                            formatter: function(params) {
                                const v = Number(params.value);
                                return (v >= 0 && v <= 1) ? (v * 100).toFixed(1) + '%' : v;
                            }
                        }
                    },
                    {
                        name: '特控率(%)',
                        type: 'line',
                        yAxisIndex: 1,
                        data: tekongRates,
                        itemStyle: { color: '#ff6b6b' },
                        lineStyle: { width: 3 },
                        label: {
                            show: true,
                            position: 'top',
                            formatter: '{c}%'
                        }
                    },
                    {
                        name: '一段率(%)',
                        type: 'line',
                        yAxisIndex: 1,
                        data: yiduanRates,
                        itemStyle: { color: '#4ecdc4' },
                        lineStyle: { width: 3, type: 'dashed' },
                        label: {
                            show: true,
                            position: 'top',
                            formatter: '{c}%'
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            setTimeout(() => chart.resize(), 50);
        }
        
        // 创建学科分数线详情图表（仅使用班级 + 过线率）
        function createSubjectLineChart(chartId, subject, subjectData, lineName) {
            const container = document.getElementById(chartId);
            if (!container) {
                console.error(`图表容器 ${chartId} 不存在`);
                return;
            }
            
            const existingChart = echarts.getInstanceByDom(container);
            if (existingChart) {
                existingChart.dispose();
            }
            
            const classNames = subjectData.class_stats.map(stat => stat.class_name);
            const passRates = subjectData.class_stats.map(stat => stat.pass_rate);
            const passedCounts = subjectData.class_stats.map(stat => stat.passed_count);
            const totalCounts = subjectData.class_stats.map(stat => stat.total_students);
            
            const chart = echarts.init(container);
            const option = {
                title: {
                    text: `${subject} - ${lineName}过线情况`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(params) {
                        const idx = params[0].dataIndex;
                        return params[0].name + '班<br/>' +
                            '过线率: <strong>' + passRates[idx] + '%</strong><br/>' +
                            '过线人数: ' + passedCounts[idx] + ' / ' + totalCounts[idx] + '人';
                    }
                },
                xAxis: {
                    type: 'category',
                    name: '班级',
                    data: classNames,
                    axisLabel: { rotate: 45 }
                },
                yAxis: {
                    type: 'value',
                    name: '过线率(%)',
                    min: 0,
                    max: 100,
                    axisLabel: { formatter: '{value}%' }
                },
                series: [
                    {
                        name: '过线率',
                        type: 'bar',
                        data: passRates,
                        itemStyle: {
                            color: function(params) {
                                const rate = params.value;
                                if (rate >= 80) return '#ff6b6b';
                                if (rate >= 60) return '#4ecdc4';
                                if (rate >= 40) return '#95e1d3';
                                return '#95a5a6';
                            }
                        },
                        label: {
                            show: true,
                            position: 'top',
                            formatter: '{c}%'
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            setTimeout(() => chart.resize(), 50);
        }
        
        // 创建总分分析图表
        function createTotalScoreChart(chartId, lineData, lineName) {
            const container = document.getElementById(chartId);
            if (!container) {
                console.error(`图表容器 ${chartId} 不存在`);
                return;
            }
            
            const existingChart = echarts.getInstanceByDom(container);
            if (existingChart) {
                existingChart.dispose();
            }
            
            const classNames = lineData.class_stats.map(stat => stat.class_name);
            const passRates = lineData.class_stats.map(stat => stat.pass_rate);
            const avgScores = lineData.class_stats.map(stat => stat.average_score);
            const passedCounts = lineData.class_stats.map(stat => stat.passed_count);
            const totalCounts = lineData.class_stats.map(stat => stat.total_students);
            
            const chart = echarts.init(container);
            const option = {
                title: {
                    text: `${lineName} - 各班级总分情况`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    formatter: function(params) {
                        let result = params[0].name + '<br/>';
                        params.forEach(function(item) {
                            const index = item.dataIndex;
                            result += item.marker + item.seriesName + ': ' + item.value;
                            if (item.seriesName === '过线率') {
                                result += '%<br/>';
                                result += '&nbsp;&nbsp;过线人数: ' + passedCounts[index] + '人<br/>';
                                result += '&nbsp;&nbsp;总人数: ' + totalCounts[index] + '人<br/>';
                                result += '&nbsp;&nbsp;平均分: ' + avgScores[index] + '分';
                            } else {
                                result += '分';
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['过线率(%)', '平均分'],
                    bottom: 10
                },
                xAxis: {
                    type: 'category',
                    data: classNames,
                    axisLabel: { rotate: 45 }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '过线率(%)',
                        position: 'left',
                        max: 100
                    },
                    {
                        type: 'value',
                        name: '平均分',
                        position: 'right'
                    }
                ],
                series: [
                    {
                        name: '过线率(%)',
                        type: 'bar',
                        data: passRates,
                        itemStyle: {
                            color: function(params) {
                                const rate = params.value;
                                if (rate >= 80) return '#ff6b6b';
                                if (rate >= 60) return '#4ecdc4';
                                if (rate >= 40) return '#95e1d3';
                                return '#95a5a6';
                            }
                        },
                        label: {
                            show: true,
                            position: 'top',
                            formatter: '{c}%'
                        }
                    },
                    {
                        name: '平均分',
                        type: 'line',
                        yAxisIndex: 1,
                        data: avgScores,
                        itemStyle: { color: '#f39c12' },
                        lineStyle: { width: 3 },
                        label: {
                            show: true,
                            position: 'top',
                            formatter: '{c}'
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            setTimeout(() => chart.resize(), 50);
        }
        
        // 快照：保存当前结果到服务器，其他老师可访问 /snap 查看
        document.getElementById('snapshotBtn').addEventListener('click', async function() {
            if (!analysisResults || Object.keys(analysisResults).length === 0) {
                alert('没有可保存的结果，请先进行分析');
                return;
            }
            var tekongEl = document.getElementById('tekongLine');
            var yiduanEl = document.getElementById('yiduanLine');
            var snapshot = {
                schoolTotalAnalysis: analysisResults.schoolTotal || null,
                subjectLinesTekong: analysisResults.subjectLinesTekong || null,
                subjectLinesYiduan: analysisResults.subjectLinesYiduan || null,
                classSubjectsTekong: analysisResults.classSubjectsTekong || null,
                classSubjectsYiduan: analysisResults.classSubjectsYiduan || null,
                classAssessment: analysisResults.classAssessment || null,
                excludedStudents: analysisResults.excludedStudents || null,
                tekongLine: tekongEl ? tekongEl.value : null,
                yiduanLine: yiduanEl ? yiduanEl.value : null,
                leagueAnalysis: analysisResults.leagueAnalysis || null
            };
            try {
                var r = await fetch('/save_snapshot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ snapshot: snapshot })
                });
                var data = await r.json();
                if (data.success) {
                    var url = window.location.origin + '/snap';
                    alert('快照已保存。其他老师可打开以下链接查看结果：\n' + url);
                    if (window.navigator.clipboard && window.navigator.clipboard.writeText) {
                        try {
                            await window.navigator.clipboard.writeText(url);
                            console.log('已复制链接到剪贴板');
                        } catch (e) {}
                    }
                } else {
                    alert('保存快照失败：' + (data.message || '未知错误'));
                }
            } catch (err) {
                console.error('快照保存失败:', err);
                alert('保存快照失败：' + err.message);
            }
        });

        // 导出Excel
        document.getElementById('exportBtn').addEventListener('click', async function() {
            if (!analysisResults || Object.keys(analysisResults).length === 0) {
                alert('没有可导出的数据，请先进行分析');
                return;
            }
            
            try {
                const response = await fetch('/export_excel', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        export_data: {
                            class_assessment: analysisResults.classAssessment || [],
                            class_subjects_tekong: analysisResults.classSubjectsTekong || {},
                            class_subjects_yiduan: analysisResults.classSubjectsYiduan || {},
                            subject_lines_tekong: analysisResults.subjectLinesTekong || {},
                            subject_lines_yiduan: analysisResults.subjectLinesYiduan || {},
                            // 校际各学科汇总（特控线 / 一段线），来自联盟分析结果
                            league_subject_summary: (analysisResults.leagueAnalysis && analysisResults.leagueAnalysis.subject_line_rankings) || {},
                            // 各校对比总表及学科表导出：联盟分析 + 特控/一段分数线（导出时从表单读取）
                            league_analysis: analysisResults.leagueAnalysis || {},
                            league_tekong_line: document.getElementById('tekongLine') && document.getElementById('tekongLine').value ? document.getElementById('tekongLine').value : null,
                            league_yiduan_line: document.getElementById('yiduanLine') && document.getElementById('yiduanLine').value ? document.getElementById('yiduanLine').value : null
                        }
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `成绩分析结果_${new Date().toISOString().slice(0,10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const result = await response.json();
                    alert('导出失败: ' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('导出失败:', error);
                alert('导出失败: ' + error.message);
            }
        });
        
        // 快照模式：用服务端注入的数据渲染结果
        if (window.__SNAPSHOT__ && typeof displayNewResults === 'function') {
            var s = window.__SNAPSHOT__;
            displayNewResults(
                s.schoolTotalAnalysis || null,
                s.subjectLinesTekong || null,
                s.subjectLinesYiduan || null,
                s.classSubjectsTekong || null,
                s.classSubjectsYiduan || null,
                s.classAssessment || null,
                s.excludedStudents || null,
                s.tekongLine != null ? s.tekongLine : null,
                s.yiduanLine != null ? s.yiduanLine : null,
                s.leagueAnalysis || null
            );
            var resArea = document.getElementById('resultsArea');
            if (resArea) resArea.style.display = 'block';
        }
        
        }); // DOMContentLoaded 结束
    </script>
</body>
</html>
